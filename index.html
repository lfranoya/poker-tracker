<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Poker Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- PWA manifest -->
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#ffffff" />

  <!-- iOS specific -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="Poker Tracker" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />

  <style>
    * {
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui, sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      background: #f3f3f5;
      color: #111;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      transition: background 0.2s, color 0.2s;
    }

    header {
      padding: 10px 14px;
      background: #ffffff;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 10;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .header-title-group {
      display: flex;
      flex-direction: column;
    }

    header h1 {
      font-size: 20px;
      margin: 0;
    }

    .app-version {
      font-size: 11px;
      color: #999;
      margin-top: 2px;
    }

    .theme-toggle {
      border-radius: 999px;
      border: 1px solid #d0d0d4;
      background: #f2f2f7;
      padding: 6px 10px;
      font-size: 16px;
      cursor: pointer;
      min-width: 40px;
    }

    main {
      padding: 16px;
      flex: 1;
      max-width: 900px;
      width: 100%;
      margin: 0 auto 8px;
    }

    .card {
      background: #ffffff;
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.07);
      transition: background 0.2s, box-shadow 0.2s, border-color 0.2s;
    }

    .card-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 8px;
      display: flex;
      align-items: baseline;
      gap: 6px;
    }

    .card-title.center {
      justify-content: center;
      text-align: center;
      width: 100%;
    }

    .control-title {
      justify-content: center;
    }

    label {
      font-size: 13px;
      display: block;
      margin-bottom: 4px;
      color: #555;
    }

    input[type="number"],
    input[type="text"],
    select {
      width: 100%;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #d0d0d4;
      font-size: 14px;
      background: #ffffff;
      color: inherit;
    }

    input[type="number"]:focus,
    input[type="text"]:focus,
    select:focus {
      outline: none;
      border-color: #007aff;
    }

    .row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }

    .row > div {
      flex: 1;
      min-width: 90px;
    }

    .player-head {
      display: grid;
      grid-template-columns: 1.3fr 0.9fr 0.9fr 1.1fr 0.7fr;
      gap: 6px;
      font-size: 11px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .player-head div {
      text-align: center;
    }

    .player-head div:first-child {
      text-align: left;
    }

    .player-row {
      display: grid;
      grid-template-columns: 1.3fr 0.9fr 0.9fr 1.1fr 0.7fr;
      gap: 6px;
      align-items: center;
      margin-bottom: 6px;
      padding: 4px 4px;
      border-radius: 8px;
      border: 1px solid transparent;
      transition: background 0.15s, border-color 0.15s;
    }

    .player-row.biggest {
      border-color: #ff9500;
      background: rgba(255,149,0,0.08);
    }

    .player-row.smallest {
      border-color: #34c759;
      background: rgba(52,199,89,0.08);
    }

    .counter {
      display: flex;
      align-items: center;
      gap: 4px;
      justify-content: center;
    }

    .counter button {
      width: 28px;
      height: 28px;
      border-radius: 6px;
      border: none;
      font-size: 18px;
      font-weight: 600;
      background: #f2f2f7;
      cursor: pointer;
      padding: 0;
    }

    .counter input {
      width: 48px;
      text-align: center;
      padding: 4px;
      border-radius: 6px;
      border: 1px solid #d0d0d4;
      font-size: 14px;
      background: #ffffff;
      color: inherit;
    }

    .spent-label {
      font-size: 14px;
      text-align: right;
      padding-right: 4px;
      min-width: 80px;
    }

    .position-select {
      text-align: center;
    }

    .summary-item {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      margin-bottom: 4px;
    }

    .summary-item strong {
      font-weight: 600;
    }

    /* swapped colors: parentheses vs Pote Total */
    .money-blue {
      color: #34a3dc; /* agora cor "cool" das linhas */
    }

    .total-pot {
      font-size: 16px;
      font-weight: 600;
      margin-top: 6px;
      color: #007aff; /* Pote Total agora nesse azul */
    }

    .btn {
      border: none;
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
    }

    .btn-danger {
      background: #ff3b30;
      color: white;
      width: 100%;
      margin-top: 8px;
    }

    /* BotÃ£o WhatsApp */
    .btn-whatsapp {
      background: #25d366;
      color: #ffffff;
      width: 100%;
      margin-top: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .wa-icon {
      font-size: 18px;
    }

    /* BotÃ£o Card laranja */
    .btn-card {
      background: #ff9500;
      color: #ffffff;
      width: 100%;
      margin-top: 6px;
    }

    .small-note {
      font-size: 11px;
      color: #888;
      margin-top: 4px;
    }

    .warning {
      color: #c00;
      font-size: 12px;
      margin-top: 4px;
    }

    footer {
      font-size: 11px;
      text-align: center;
      padding: 6px 12px 10px;
      color: #666;
    }

    /* Resultado (+ / -) */
    .pay-receive {
      font-weight: 600;
    }
    .pay-receive--positive {
      color: #34c759;
    }
    .pay-receive--negative {
      color: #ff3b30;
    }

    /* Destaque para nomes premiados */
    .player-name {
      font-weight: 600;
    }
    .player-name-1 {
      color: #34c759;  /* verde */
    }
    .player-name-2 {
      color: #ff9500;  /* laranja */
    }
    .player-name-3 {
      color: #007aff;  /* azul para 3Âº */
    }

    /* Linhas de separaÃ§Ã£o agora finas e cinza claro */
    .strong-separator {
      margin: 12px 0 8px;
      border: none;
      border-top: 1px solid #cccccc;
    }

    /* Dark mode */
    body.dark {
      background: #111111;
      color: #f5f5f5;
    }

    body.dark header {
      background: #1c1c1e;
      box-shadow: 0 1px 3px rgba(0,0,0,0.7);
    }

    body.dark .card {
      background: #1c1c1e;
      box-shadow: 0 1px 3px rgba(0,0,0,0.7);
      border: 1px solid #2c2c2e;
    }

    body.dark input[type="number"],
    body.dark input[type="text"],
    body.dark select {
      background: #2c2c2e;
      border-color: #3a3a3c;
      color: #f5f5f5;
    }

    body.dark .counter button {
      background: #2c2c2e;
      color: #f5f5f5;
    }

    body.dark .btn-danger {
      background: #ff453a;
    }

    body.dark .btn-whatsapp {
      background: #25d366;
      color: #ffffff;
    }

    body.dark .btn-card {
      background: #ff9f0a;
      color: #ffffff;
    }

    body.dark .small-note {
      color: #aaa;
    }

    body.dark footer {
      color: #999;
    }

    body.dark .player-row.biggest {
      background: rgba(255,159,10,0.25);
      border-color: #ff9f0a;
    }

    body.dark .player-row.smallest {
      background: rgba(48,209,88,0.3);
      border-color: #30d158;
    }

    body.dark .strong-separator {
      border-top-color: #555555;
    }

    @media (max-width: 480px) {
      .player-head,
      .player-row {
        grid-template-columns: 1.3fr 0.9fr 0.9fr 1.1fr 0.7fr;
      }
    }

    /* Listas de ranking / resumo */
    .ranking-list {
      margin-top: 8px;
      font-size: 14px;
    }
    .ranking-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 2px 0;
    }
    .ranking-left {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .ranking-icon {
      width: 22px;
      text-align: center;
    }
    .ranking-name {
      max-width: 160px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .detailed-item {
      font-size: 14px;
      margin: 2px 0;
      text-align: left;
    }

    /* Canvas (card PNG) */
    #summaryCanvas {
      display: none;
    }
  </style>
</head>
<body>
  <header>
    <div class="header-title-group">
      <h1 id="headerTitle">Poker</h1>
      <div id="appVersion" class="app-version"></div>
    </div>
    <button id="themeToggle" class="theme-toggle" aria-label="Alternar tema">ðŸŒ™</button>
  </header>

  <main>
    <!-- ConfiguraÃ§Ãµes -->
    <section class="card">
      <div class="card-title">ConfiguraÃ§Ãµes do Jogo</div>
      <div class="row">
        <div>
          <label for="buyInValue">Valor do Buy-In (R$)</label>
          <input id="buyInValue" type="number" min="0" step="0.01" inputmode="decimal" />
        </div>
        <div>
          <label for="rebuyValue">Valor do Rebuy (R$)</label>
          <input id="rebuyValue" type="number" min="0" step="0.01" inputmode="decimal" />
        </div>
      </div>
      <div class="row">
        <div>
          <label for="buyInChips">Fichas Buy-In</label>
          <input id="buyInChips" type="number" min="0" step="1" inputmode="numeric" />
        </div>
        <div>
          <label for="rebuyChips">Fichas Rebuy</label>
          <input id="rebuyChips" type="number" min="0" step="1" inputmode="numeric" />
        </div>
      </div>

      <div style="margin-top:8px;">
        <div class="card-title" style="font-size:14px;margin-bottom:4px;">DistribuiÃ§Ã£o de prÃªmios (%)</div>
        <div class="row">
          <div>
            <label for="prize1">1Âº lugar</label>
            <input id="prize1" type="number" min="0" max="100" step="1" />
          </div>
          <div>
            <label for="prize2">2Âº lugar</label>
            <input id="prize2" type="number" min="0" max="100" step="1" />
          </div>
          <div>
            <label for="prize3">3Âº lugar</label>
            <input id="prize3" type="number" min="0" max="100" step="1" />
          </div>
        </div>
        <div id="prizeSumWarning" class="warning" style="display:none;"></div>
      </div>

      <button id="resetSession" class="btn btn-danger">Zerar rodada</button>
    </section>

    <!-- Controle do jogo -->
    <section class="card">
      <div class="card-title control-title">Controle do Jogo</div>
      <div class="player-head">
        <div>Jogador</div>
        <div>Buy-Ins</div>
        <div>Rebuys</div>
        <div>Total gasto</div>
        <div>PosiÃ§Ã£o</div>
      </div>
      <div id="playersContainer"></div>
      <div class="small-note">
        A lista acima jÃ¡ estÃ¡ ordenada pelo total gasto (do maior para o menor).
      </div>
    </section>

    <!-- VALORES -->
    <section class="card">
      <div class="card-title center" id="valuesTitle">VALORES</div>

      <div class="summary-item">
        <span>Total de Buy-Ins</span><strong id="totalBuyIns">0</strong>
      </div>
      <div class="summary-item">
        <span>Total de Rebuys</span><strong id="totalRebuys">0</strong>
      </div>
      <div class="total-pot">
        Pote Total: <span id="totalPot">R$ 0,00</span>
      </div>

      <!-- Linha entre Pote Total e PRÃŠMIOS -->
      <hr class="strong-separator">

      <!-- PRÃŠMIOS (somente valores, sem nomes/Ã­cones/resultado) -->
      <div class="card-title" style="margin-top:4px;">PRÃŠMIOS</div>
      <div class="summary-item">
        <span>1Âº lugar</span>
        <strong id="prize1Amount">R$ 0,00</strong>
      </div>
      <div class="summary-item">
        <span>2Âº lugar</span>
        <strong id="prize2Amount">R$ 0,00</strong>
      </div>
      <div class="summary-item">
        <span>3Âº lugar</span>
        <strong id="prize3Amount">R$ 0,00</strong>
      </div>
    </section>

    <!-- RESULTADOS (Ranking + Resultados detalhados) -->
    <section class="card">
      <div class="card-title center" id="resultsTitle">RESULTADOS</div>

      <div class="card-title" style="font-style:italic;margin-top:4px;">RANKING</div>
      <div id="rankingList" class="ranking-list"></div>

      <!-- Linha entre Ranking e Resultados detalhados -->
      <hr class="strong-separator">

      <div class="card-title" style="font-style:italic;margin-top:4px;">RESULTADOS DETALHADOS</div>
      <div id="playersSummaryList" class="ranking-list"></div>
    </section>

    <!-- BotÃµes (WhatsApp + Card) em bubble separado -->
    <section class="card">
      <div class="card-title center">Compartilhar</div>
      <button id="whatsappShareBtn" class="btn btn-whatsapp">
        <span class="wa-icon">ðŸŸ¢</span>
        <span>Enviar WhatsApp</span>
      </button>
      <button id="pngCardBtn" class="btn btn-card">Gerar Card</button>

      <!-- Canvas escondido para gerar o card PNG -->
      <canvas id="summaryCanvas" width="900" height="700"></canvas>
    </section>
  </main>

  <footer>
    Dados ficam somente neste dispositivo Â· Funciona offline apÃ³s o primeiro acesso
  </footer>

  <script>
    const APP_VERSION = "v1.3";
    const STORAGE_KEY = "poker_tracker_state_" + APP_VERSION;
    const THEME_KEY   = "poker_tracker_theme_" + APP_VERSION;

    // Cache de prÃªmios para usar em ranking, WhatsApp e card
    let prizeCache = {
      totalPot: 0,
      p1: 0,
      p2: 0,
      p3: 0
    };

    // FormataÃ§Ã£o R$
    let moneyFormatter;
    try {
      moneyFormatter = new Intl.NumberFormat("pt-BR", {
        style: "currency",
        currency: "BRL",
        minimumFractionDigits: 2
      });
    } catch (e) {
      moneyFormatter = {
        format(v) {
          return "R$ " + Number(v).toFixed(2).replace(".", ",");
        }
      };
    }

    function formatMoney(v) {
      return moneyFormatter.format(v || 0);
    }

    function toNumber(v, def = 0) {
      if (v === null || v === undefined) return def;
      const normalized = String(v).replace(",", ".");
      const n = parseFloat(normalized);
      return isNaN(n) ? def : n;
    }

    function defaultState() {
      return {
        settings: {
          buyInValue: 50,   // default 50
          rebuyValue: 50,   // default 50
          buyInChips: 0,
          rebuyChips: 0,
          prize1: 50,
          prize2: 30,
          prize3: 20
        },
        players: Array.from({ length: 10 }, (_, i) => ({
          id: i,
          name: "",
          buyIns: 0,
          rebuys: 0,
          placement: ""
        }))
      };
    }

    function loadState() {
      try {
        const data = localStorage.getItem(STORAGE_KEY);
        if (!data) return defaultState();
        const parsed = JSON.parse(data);

        if (!parsed.settings) parsed.settings = {};
        const def = defaultState().settings;
        parsed.settings.buyInValue  = toNumber(parsed.settings.buyInValue, def.buyInValue);
        parsed.settings.rebuyValue  = toNumber(parsed.settings.rebuyValue, def.rebuyValue);
        parsed.settings.buyInChips  = toNumber(parsed.settings.buyInChips, def.buyInChips);
        parsed.settings.rebuyChips  = toNumber(parsed.settings.rebuyChips, def.rebuyChips);
        parsed.settings.prize1      = toNumber(parsed.settings.prize1, def.prize1);
        parsed.settings.prize2      = toNumber(parsed.settings.prize2, def.prize2);
        parsed.settings.prize3      = toNumber(parsed.settings.prize3, def.prize3);

        if (!parsed.players || parsed.players.length !== 10) {
          parsed.players = defaultState().players;
        } else {
          parsed.players = parsed.players.map((p, i) => ({
            id: i,
            name: p.name || "",
            buyIns: toNumber(p.buyIns, 0),
            rebuys: toNumber(p.rebuys, 0),
            placement: p.placement === 1 || p.placement === "1" ? "1"
                      : p.placement === 2 || p.placement === "2" ? "2"
                      : p.placement === 3 || p.placement === "3" ? "3"
                      : ""
          }));
        }
        return parsed;
      } catch (e) {
        console.error("Error loading state", e);
        return defaultState();
      }
    }

    function saveState(state) {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      } catch (e) {
        console.error("Error saving state", e);
      }
    }

    let state = loadState();

    // Data de hoje
    function getTodayString() {
      try {
        return new Date().toLocaleDateString("pt-BR");
      } catch (e) {
        return "";
      }
    }

    function getDisplayName(p) {
      const base = (p.name && p.name.trim()) || ("Jogador " + (p.index + 1));
      return base;
    }

    function getPlacementColor(placement) {
      if (placement === "1") return "#34c759";
      if (placement === "2") return "#ff9500";
      if (placement === "3") return "#007aff";
      return "#111111";
    }

    // DOM refs
    const headerTitleEl = document.getElementById("headerTitle");
    const appVersionEl  = document.getElementById("appVersion");

    const buyInInput = document.getElementById("buyInValue");
    const rebuyInput = document.getElementById("rebuyValue");
    const buyInChipsInput = document.getElementById("buyInChips");
    const rebuyChipsInput = document.getElementById("rebuyChips");
    const prize1Input = document.getElementById("prize1");
    const prize2Input = document.getElementById("prize2");
    const prize3Input = document.getElementById("prize3");
    const prizeSumWarning = document.getElementById("prizeSumWarning");
    const playersContainer = document.getElementById("playersContainer");

    const totalBuyInsEl = document.getElementById("totalBuyIns");
    const totalRebuysEl = document.getElementById("totalRebuys");
    const totalPotEl = document.getElementById("totalPot");
    const prize1AmountEl = document.getElementById("prize1Amount");
    const prize2AmountEl = document.getElementById("prize2Amount");
    const prize3AmountEl = document.getElementById("prize3Amount");

    const rankingListEl = document.getElementById("rankingList");
    const playersSummaryListEl = document.getElementById("playersSummaryList");

    const themeToggleBtn = document.getElementById("themeToggle");
    const whatsappShareBtn = document.getElementById("whatsappShareBtn");
    const pngCardBtn = document.getElementById("pngCardBtn");
    const summaryCanvas = document.getElementById("summaryCanvas");

    function updateDateLabels() {
      const d = getTodayString();
      if (headerTitleEl) {
        headerTitleEl.textContent = d ? "Poker - " + d : "Poker";
      }
      if (appVersionEl) {
        appVersionEl.textContent = APP_VERSION;
      }
    }

    // Tema
    function applyTheme(theme) {
      if (theme === "dark") {
        document.body.classList.add("dark");
        themeToggleBtn.textContent = "â˜€ï¸";
      } else {
        document.body.classList.remove("dark");
        themeToggleBtn.textContent = "ðŸŒ™";
      }
    }

    function loadTheme() {
      const stored = localStorage.getItem(THEME_KEY);
      const theme = stored === "dark" ? "dark" : "light";
      applyTheme(theme);
    }

    function toggleTheme() {
      const isDark = document.body.classList.contains("dark");
      const newTheme = isDark ? "light" : "dark";
      applyTheme(newTheme);
      localStorage.setItem(THEME_KEY, newTheme);
    }

    themeToggleBtn.addEventListener("click", toggleTheme);
    loadTheme();
    updateDateLabels();

    function renderSettings() {
      buyInInput.value = state.settings.buyInValue;
      rebuyInput.value = state.settings.rebuyValue;
      buyInChipsInput.value = state.settings.buyInChips;
      rebuyChipsInput.value = state.settings.rebuyChips;
      prize1Input.value = state.settings.prize1;
      prize2Input.value = state.settings.prize2;
      prize3Input.value = state.settings.prize3;
      updatePrizeSumWarning();
    }

    function updatePrizeSumWarning() {
      const s = state.settings;
      const sum =
        toNumber(s.prize1) + toNumber(s.prize2) + toNumber(s.prize3);
      if (sum !== 100) {
        prizeSumWarning.style.display = "block";
        prizeSumWarning.textContent =
          "AtenÃ§Ã£o: a soma dos prÃªmios Ã© " + sum + "% (nÃ£o 100%).";
      } else {
        prizeSumWarning.style.display = "none";
      }
    }

    function buildPlayersWithTotals() {
      const buyInValue = toNumber(state.settings.buyInValue);
      const rebuyValue = toNumber(state.settings.rebuyValue);

      return state.players.map((p, index) => {
        const totalSpent = p.buyIns * buyInValue + p.rebuys * rebuyValue;
        return { ...p, index, totalSpent };
      });
    }

    function renderRankingAndSummary(playersWithTotalsSorted) {
      const buyInValue = toNumber(state.settings.buyInValue);
      const rebuyValue = toNumber(state.settings.rebuyValue);

      rankingListEl.innerHTML = "";
      playersSummaryListEl.innerHTML = "";

      // Ranking de posiÃ§Ãµes 1,2,3
      const rankingPlayers = playersWithTotalsSorted
        .filter(p => p.placement === "1" || p.placement === "2" || p.placement === "3")
        .sort((a, b) => Number(a.placement) - Number(b.placement));

      if (rankingPlayers.length === 0) {
        rankingListEl.innerHTML =
          '<div class="small-note">Ainda nÃ£o hÃ¡ posiÃ§Ãµes definidas.</div>';
      } else {
        rankingPlayers.forEach((p) => {
          const div = document.createElement("div");
          div.className = "ranking-item";

          const left = document.createElement("div");
          left.className = "ranking-left";

          const icon = document.createElement("div");
          icon.className = "ranking-icon";

          if (p.placement === "1") icon.textContent = "ðŸ¥‡";
          else if (p.placement === "2") icon.textContent = "ðŸ¥ˆ";
          else if (p.placement === "3") icon.textContent = "ðŸ¥‰";
          else icon.textContent = p.placement + "Âº";

          const nameSpan = document.createElement("span");
          nameSpan.className = "ranking-name";
          nameSpan.textContent = getDisplayName(p);

          const lineColor = getPlacementColor(p.placement);

          left.style.color = lineColor;
          nameSpan.style.fontWeight = "600";

          left.appendChild(icon);
          left.appendChild(nameSpan);

          const right = document.createElement("div");
          const placePrize =
            p.placement === "1" ? prizeCache.p1 :
            p.placement === "2" ? prizeCache.p2 :
            p.placement === "3" ? prizeCache.p3 : 0;
          const resultado = placePrize - p.totalSpent;

          // todo o lado direito na cor da posiÃ§Ã£o, exceto o resultado
          right.style.color = lineColor;

          if (resultado > 0) {
            right.innerHTML =
              `PrÃªmio: ${formatMoney(placePrize)} | ` +
              `<span class="pay-receive pay-receive--positive">Resultado: + ${formatMoney(Math.abs(resultado))}</span>`;
          } else if (resultado < 0) {
            right.innerHTML =
              `PrÃªmio: ${formatMoney(placePrize)} | ` +
              `<span class="pay-receive pay-receive--negative">Resultado: - ${formatMoney(Math.abs(resultado))}</span>`;
          } else {
            right.innerHTML =
              `PrÃªmio: ${formatMoney(placePrize)} | ` +
              `<span class="pay-receive">Resultado: ${formatMoney(0)}</span>`;
          }

          div.appendChild(left);
          div.appendChild(right);
          rankingListEl.appendChild(div);
        });
      }

      // Resultados detalhados (1+ Buy-In), ordem alfabÃ©tica por nome
      const summaryPlayers = playersWithTotalsSorted
        .filter(p => p.buyIns >= 1)
        .sort((a, b) => {
          const na = getDisplayName(a).toLocaleLowerCase("pt-BR");
          const nb = getDisplayName(b).toLocaleLowerCase("pt-BR");
          if (na < nb) return -1;
          if (na > nb) return 1;
          return 0;
        });

      if (summaryPlayers.length === 0) {
        playersSummaryListEl.innerHTML =
          '<div class="small-note">Nenhum jogador com Buy-In registrado.</div>';
      } else {
        summaryPlayers.forEach((p) => {
          const div = document.createElement("div");
          div.className = "detailed-item";

          const totalBuyInValue = p.buyIns * buyInValue;
          const totalRebuyValue = p.rebuys * rebuyValue;
          const placePrize =
            p.placement === "1" ? prizeCache.p1 :
            p.placement === "2" ? prizeCache.p2 :
            p.placement === "3" ? prizeCache.p3 : 0;
          const resultado = placePrize - p.totalSpent;

          const namePlain = getDisplayName(p);
          const lineColor = getPlacementColor(p.placement);
          const isWinner = p.placement === "1" || p.placement === "2" || p.placement === "3";

          const prefixText =
            `${namePlain} - BI: ${p.buyIns} (${formatMoney(totalBuyInValue)}) ` +
            `| RB: ${p.rebuys} (${formatMoney(totalRebuyValue)}) ` +
            `| GASTO: ${formatMoney(p.totalSpent)}`;

          // PRÃŠMIO sÃ³ aparece se > 0
          let premioText = "";
          if (placePrize > 0) {
            premioText = ` | PRÃŠMIO: ${formatMoney(placePrize)}`;
          }

          let resultClass = "pay-receive";
          let resultText;
          if (resultado > 0) {
            resultClass += " pay-receive--positive";
            resultText = `Resultado: + ${formatMoney(Math.abs(resultado))}`;
          } else if (resultado < 0) {
            resultClass += " pay-receive--negative";
            resultText = `Resultado: - ${formatMoney(Math.abs(resultado))}`;
          } else {
            resultText = `Resultado: ${formatMoney(0)}`;
          }
          const resultadoHTML = `<span class="${resultClass}">${resultText}</span>`;

          let beforeResultHTML;
          if (isWinner) {
            beforeResultHTML =
              `<span style="color:${lineColor};font-weight:600;">${prefixText}${premioText}</span>`;
          } else {
            beforeResultHTML = `${prefixText}${premioText}`;
          }

          div.innerHTML = `${beforeResultHTML} | ${resultadoHTML}`;
          playersSummaryListEl.appendChild(div);
        });
      }
    }

    function renderPlayers() {
      playersContainer.innerHTML = "";

      const playersWithTotals = buildPlayersWithTotals();
      const totals = playersWithTotals.map((p) => p.totalSpent);
      const maxSpent = Math.max(...totals, 0);
      const positiveTotals = totals.filter((v) => v > 0);
      const minSpent =
        positiveTotals.length > 0 ? Math.min(...positiveTotals) : 0;

      // Ordena do maior gasto para o menor
      playersWithTotals.sort((a, b) => b.totalSpent - a.totalSpent);

      playersWithTotals.forEach((p) => {
        const row = document.createElement("div");
        row.className = "player-row";

        if (p.totalSpent > 0 && p.totalSpent === maxSpent) {
          row.classList.add("biggest");
        }
        if (p.totalSpent > 0 && p.totalSpent === minSpent && maxSpent !== minSpent) {
          row.classList.add("smallest");
        }

        // Nome
        const nameDiv = document.createElement("div");
        const nameInput = document.createElement("input");
        nameInput.type = "text";
        nameInput.placeholder = "Jogador " + (p.index + 1);
        nameInput.value = p.name || "";
        nameInput.addEventListener("input", () => {
          state.players[p.index].name = nameInput.value;
          saveState(state);
          renderRankingAndSummary(buildPlayersWithTotals().sort((a, b) => b.totalSpent - a.totalSpent));
        });
        nameDiv.appendChild(nameInput);

        // Buy-Ins
        const buyDiv = document.createElement("div");
        const buyCounter = document.createElement("div");
        buyCounter.className = "counter";

        const buyMinus = document.createElement("button");
        buyMinus.textContent = "â€“";

        const buyInput = document.createElement("input");
        buyInput.type = "number";
        buyInput.min = "0";
        buyInput.step = "1";
        buyInput.value = p.buyIns;

        const buyPlus = document.createElement("button");
        buyPlus.textContent = "+";

        buyCounter.appendChild(buyMinus);
        buyCounter.appendChild(buyInput);
        buyCounter.appendChild(buyPlus);
        buyDiv.appendChild(buyCounter);

        // Rebuys
        const rebuyDiv = document.createElement("div");
        const rebuyCounter = document.createElement("div");
        rebuyCounter.className = "counter";

        const rebuyMinus = document.createElement("button");
        rebuyMinus.textContent = "â€“";

        const rebuyInput = document.createElement("input");
        rebuyInput.type = "number";
        rebuyInput.min = "0";
        rebuyInput.step = "1";
        rebuyInput.value = p.rebuys;

        const rebuyPlus = document.createElement("button");
        rebuyPlus.textContent = "+";

        rebuyCounter.appendChild(rebuyMinus);
        rebuyCounter.appendChild(rebuyInput);
        rebuyCounter.appendChild(rebuyPlus);
        rebuyDiv.appendChild(rebuyCounter);

        // Total gasto
        const spentDiv = document.createElement("div");
        const spentLabel = document.createElement("div");
        spentLabel.className = "spent-label";
        spentLabel.textContent = formatMoney(p.totalSpent);
        spentDiv.appendChild(spentLabel);

        // PosiÃ§Ã£o (dropdown) com lÃ³gica de exclusividade
        const posDiv = document.createElement("div");
        const posSelect = document.createElement("select");
        posSelect.className = "position-select";

        const optEmpty = document.createElement("option");
        optEmpty.value = "";
        optEmpty.textContent = "â€”";

        const opt1 = document.createElement("option");
        opt1.value = "1";
        opt1.textContent = "1Âº";

        const opt2 = document.createElement("option");
        opt2.value = "2";
        opt2.textContent = "2Âº";

        const opt3 = document.createElement("option");
        opt3.value = "3";
        opt3.textContent = "3Âº";

        posSelect.appendChild(optEmpty);
        posSelect.appendChild(opt1);
        posSelect.appendChild(opt2);
        posSelect.appendChild(opt3);

        posSelect.value = p.placement || "";

        posSelect.addEventListener("change", () => {
          const idx = p.index;
          const newVal = posSelect.value;

          // Exclusividade: se outra pessoa jÃ¡ tinha essa posiÃ§Ã£o, volta para "â€”"
          if (newVal === "1" || newVal === "2" || newVal === "3") {
            state.players.forEach((pl, i) => {
              if (i !== idx && pl.placement === newVal) {
                pl.placement = "";
              }
            });
          }

          state.players[idx].placement = newVal;
          saveState(state);
          renderPlayers();
        });

        posDiv.appendChild(posSelect);

        row.appendChild(nameDiv);
        row.appendChild(buyDiv);
        row.appendChild(rebuyDiv);
        row.appendChild(spentDiv);
        row.appendChild(posDiv);
        playersContainer.appendChild(row);

        function updatePlayer(newBuyIns, newRebuys) {
          const idx = p.index;
          state.players[idx].buyIns = Math.max(
            0,
            Math.floor(toNumber(newBuyIns, 0))
          );
          state.players[idx].rebuys = Math.max(
            0,
            Math.floor(toNumber(newRebuys, 0))
          );
          saveState(state);
          renderPlayers();
          recalc();
        }

        buyMinus.addEventListener("click", () => {
          updatePlayer(p.buyIns - 1, p.rebuys);
        });
        buyPlus.addEventListener("click", () => {
          updatePlayer(p.buyIns + 1, p.rebuys);
        });
        rebuyMinus.addEventListener("click", () => {
          updatePlayer(p.buyIns, p.rebuys - 1);
        });
        rebuyPlus.addEventListener("click", () => {
          updatePlayer(p.buyIns, p.rebuys + 1);
        });

        buyInput.addEventListener("change", () => {
          updatePlayer(buyInput.value, p.rebuys);
        });
        rebuyInput.addEventListener("change", () => {
          updatePlayer(p.buyIns, rebuyInput.value);
        });
      });

      renderRankingAndSummary(playersWithTotals);
    }

    function recalc() {
      const buyInValue = toNumber(state.settings.buyInValue);
      const rebuyValue = toNumber(state.settings.rebuyValue);

      let totalBuyIns = 0;
      let totalRebuys = 0;
      state.players.forEach((p) => {
        totalBuyIns += toNumber(p.buyIns);
        totalRebuys += toNumber(p.rebuys);
      });

      const totalFromBuyIns = totalBuyIns * buyInValue;
      const totalFromRebuys = totalRebuys * rebuyValue;
      const totalPot = totalFromBuyIns + totalFromRebuys;

      // Totais com valor arrecadado usando cor "cool"
      totalBuyInsEl.innerHTML =
        `${totalBuyIns} (<span class="money-blue">${formatMoney(totalFromBuyIns)}</span>)`;
      totalRebuysEl.innerHTML =
        `${totalRebuys} (<span class="money-blue">${formatMoney(totalFromRebuys)}</span>)`;
      totalPotEl.textContent = formatMoney(totalPot);

      const p1 = toNumber(state.settings.prize1);
      const p2 = toNumber(state.settings.prize2);
      const p3 = toNumber(state.settings.prize3);

      let prize1Amount = (totalPot * p1) / 100;
      let prize2Amount = (totalPot * p2) / 100;
      let prize3Amount = (totalPot * p3) / 100;

      const totalPrizes = prize1Amount + prize2Amount + prize3Amount;
      const diff = totalPot - totalPrizes;
      prize1Amount += diff; // ajustes de centavos

      prize1AmountEl.textContent = formatMoney(prize1Amount);
      prize2AmountEl.textContent = formatMoney(prize2Amount);
      prize3AmountEl.textContent = formatMoney(prize3Amount);

      prizeCache.totalPot = totalPot;
      prizeCache.p1 = prize1Amount;
      prizeCache.p2 = prize2Amount;
      prizeCache.p3 = prize3Amount;

      renderRankingAndSummary(buildPlayersWithTotals().sort((a, b) => b.totalSpent - a.totalSpent));
    }

    // Resumo para WhatsApp (com Buy-In/Rebuy capitalizados e ordem alfabÃ©tica nos detalhados)
    function buildWhatsappSummary() {
      recalc(); // garante prÃªmios atualizados

      const buyInValue = toNumber(state.settings.buyInValue);
      const rebuyValue = toNumber(state.settings.rebuyValue);

      let totalBuyIns = 0;
      let totalRebuys = 0;
      state.players.forEach((p) => {
        totalBuyIns += toNumber(p.buyIns);
        totalRebuys += toNumber(p.rebuys);
      });

      const totalPot = prizeCache.totalPot;
      const playersSorted = buildPlayersWithTotals().sort((a, b) => b.totalSpent - a.totalSpent);

      const rankingPlayers = playersSorted
        .filter(p => p.placement === "1" || p.placement === "2" || p.placement === "3")
        .sort((a, b) => Number(a.placement) - Number(b.placement));

      const summaryPlayers = playersSorted
        .filter(p => p.buyIns >= 1)
        .sort((a, b) => {
          const na = getDisplayName(a).toLocaleLowerCase("pt-BR");
          const nb = getDisplayName(b).toLocaleLowerCase("pt-BR");
          if (na < nb) return -1;
          if (na > nb) return 1;
          return 0;
        });

      const today = getTodayString();

      let lines = [];
      if (today) {
        lines.push("Resultados Poker - " + today);
      } else {
        lines.push("Resultados Poker");
      }
      lines.push(`Pote Total: ${formatMoney(totalPot)}`);
      lines.push(
        `Buy-Ins: ${totalBuyIns} (${formatMoney(totalBuyIns * buyInValue)}) Â· ` +
        `Rebuys: ${formatMoney(totalRebuys * rebuyValue)}`
      );
      lines.push("");

      if (rankingPlayers.length > 0) {
        lines.push("Ranking:");
        rankingPlayers.forEach((p) => {
          const place = p.placement;
          let icon = "";
          if (place === "1") icon = "1Âº";
          else if (place === "2") icon = "2Âº";
          else if (place === "3") icon = "3Âº";
          else icon = place + "Âº";

          const name = getDisplayName(p);
          const placePrize =
            place === "1" ? prizeCache.p1 :
            place === "2" ? prizeCache.p2 :
            place === "3" ? prizeCache.p3 : 0;
          const resultado = placePrize - p.totalSpent;

          if (resultado > 0) {
            lines.push(
              `${icon} ${name} â€“ PrÃªmio: ${formatMoney(placePrize)} | ` +
              `Resultado: + ${formatMoney(Math.abs(resultado))}`
            );
          } else if (resultado < 0) {
            lines.push(
              `${icon} ${name} â€“ PrÃªmio: ${formatMoney(placePrize)} | ` +
              `Resultado: - ${formatMoney(Math.abs(resultado))}`
            );
          } else {
            lines.push(
              `${icon} ${name} â€“ PrÃªmio: ${formatMoney(placePrize)} | ` +
              `Resultado: ${formatMoney(0)}`
            );
          }
        });
        lines.push("");
      } else {
        lines.push("Sem posiÃ§Ãµes definidas.");
        lines.push("");
      }

      lines.push("Resultados detalhados:");
      if (summaryPlayers.length === 0) {
        lines.push("Nenhum jogador com Buy-In registrado.");
      } else {
        summaryPlayers.forEach((p) => {
          const name = getDisplayName(p);
          const totalBuyInValue = p.buyIns * buyInValue;
          const totalRebuyValue = p.rebuys * rebuyValue;
          const placePrize =
            p.placement === "1" ? prizeCache.p1 :
            p.placement === "2" ? prizeCache.p2 :
            p.placement === "3" ? prizeCache.p3 : 0;
          const resultado = placePrize - p.totalSpent;

          let premioText = "";
          if (placePrize > 0) {
            premioText = ` | PRÃŠMIO: ${formatMoney(placePrize)}`;
          }

          let resultadoText = "";
          if (resultado > 0) {
            resultadoText = ` | Resultado: + ${formatMoney(Math.abs(resultado))}`;
          } else if (resultado < 0) {
            resultadoText = ` | Resultado: - ${formatMoney(Math.abs(resultado))}`;
          } else {
            resultadoText = ` | Resultado: ${formatMoney(0)}`;
          }

          lines.push(
            `${name} - BI: ${p.buyIns} (${formatMoney(totalBuyInValue)}) | ` +
            `RB: ${p.rebuys} (${formatMoney(totalRebuyValue)}) | ` +
            `GASTO: ${formatMoney(p.totalSpent)}` +
            `${premioText}` +
            `${resultadoText}`
          );
          lines.push(""); // linha em branco entre jogadores
        });
      }

      return lines.join("\n");
    }

    whatsappShareBtn.addEventListener("click", () => {
      const text = buildWhatsappSummary();

      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).catch(() => {});
      }

      const url = "https://wa.me/?text=" + encodeURIComponent(text);
      window.open(url, "_blank");
    });

    // Card em PNG (cores ajustadas para winners)
    function drawSummaryCard() {
      recalc(); // garante prÃªmios atualizados

      const ctx = summaryCanvas.getContext("2d");
      const width = summaryCanvas.width;
      const height = summaryCanvas.height;

      ctx.fillStyle = "#ffffff";
      ctx.fillRect(0, 0, width, height);

      const today = getTodayString();
      let title = "Resultados Poker";
      if (today) title += " - " + today;

      ctx.fillStyle = "#111111";
      ctx.font = "28px -apple-system, system-ui, sans-serif";
      ctx.fillText(title, 40, 60);

      let y = 100;
      ctx.font = "18px -apple-system, system-ui, sans-serif";

      let totalBuyIns = 0;
      let totalRebuys = 0;
      state.players.forEach((p) => {
        totalBuyIns += toNumber(p.buyIns);
        totalRebuys += toNumber(p.rebuys);
      });

      const totalPot = prizeCache.totalPot;
      const buyInValue = toNumber(state.settings.buyInValue);
      const rebuyValue = toNumber(state.settings.rebuyValue);

      // Pote Total em negrito e azul/teal (nova cor)
      ctx.fillStyle = "#007aff";
      ctx.font = "bold 18px -apple-system, system-ui, sans-serif";
      ctx.fillText(`Pote Total: ${formatMoney(totalPot)}`, 40, y);
      y += 30;

      ctx.fillStyle = "#34a3dc";
      ctx.font = "18px -apple-system, system-ui, sans-serif";
      ctx.fillText(
        `Buy-Ins: ${totalBuyIns} (${formatMoney(totalBuyIns * buyInValue)}) Â· ` +
        `Rebuys: ${totalRebuys} (${formatMoney(totalRebuys * rebuyValue)})`,
        40,
        y
      );
      y += 40;

      const playersSorted = buildPlayersWithTotals().sort((a, b) => b.totalSpent - a.totalSpent);
      const rankingPlayers = playersSorted
        .filter(p => p.placement === "1" || p.placement === "2" || p.placement === "3")
        .sort((a, b) => Number(a.placement) - Number(b.placement));
      const summaryPlayers = playersSorted
        .filter(p => p.buyIns >= 1)
        .sort((a, b) => {
          const na = getDisplayName(a).toLocaleLowerCase("pt-BR");
          const nb = getDisplayName(b).toLocaleLowerCase("pt-BR");
          if (na < nb) return -1;
          if (na > nb) return 1;
          return 0;
        });

      // RANKING
      ctx.font = "italic bold 18px -apple-system, system-ui, sans-serif";
      ctx.fillStyle = "#111111";
      ctx.fillText("Ranking:", 40, y);
      y += 30;

      ctx.font = "16px -apple-system, system-ui, sans-serif";

      if (rankingPlayers.length === 0) {
        ctx.fillText("Sem posiÃ§Ãµes definidas.", 40, y);
        y += 30;
      } else {
        rankingPlayers.forEach((p) => {
          const place = p.placement;
          let icon = "";
          if (place === "1") icon = "ðŸ¥‡";
          else if (place === "2") icon = "ðŸ¥ˆ";
          else if (place === "3") icon = "ðŸ¥‰";
          else icon = place + "Âº";

          const name = getDisplayName(p);
          const placePrize =
            place === "1" ? prizeCache.p1 :
            place === "2" ? prizeCache.p2 :
            place === "3" ? prizeCache.p3 : 0;
          const resultado = placePrize - p.totalSpent;

          const lineColor = getPlacementColor(place);

          const prefix = icon + " " + name + " â€“ PrÃªmio: " + formatMoney(placePrize) + " | ";
          ctx.fillStyle = lineColor;
          if (y >= height - 20) return;
          ctx.fillText(prefix, 40, y);
          const prefixWidth = ctx.measureText(prefix).width;

          let resultText;
          let resultColor = "#111111";
          if (resultado > 0) {
            resultText = `Resultado: + ${formatMoney(Math.abs(resultado))}`;
            resultColor = "#34c759";
          } else if (resultado < 0) {
            resultText = `Resultado: - ${formatMoney(Math.abs(resultado))}`;
            resultColor = "#ff3b30";
          } else {
            resultText = `Resultado: ${formatMoney(0)}`;
          }

          ctx.fillStyle = resultColor;
          ctx.fillText(resultText, 40 + prefixWidth, y);

          y += 24;
        });
      }

      y += 20;
      // Resultados detalhados
      ctx.font = "italic bold 18px -apple-system, system-ui, sans-serif";
      ctx.fillStyle = "#111111";
      ctx.fillText("Resultados detalhados:", 40, y);
      y += 30;

      ctx.font = "16px -apple-system, system-ui, sans-serif";

      if (summaryPlayers.length === 0) {
        ctx.fillText("Nenhum jogador com Buy-In registrado.", 40, y);
      } else {
        summaryPlayers.forEach((p) => {
          if (y >= height - 20) return;

          const name = getDisplayName(p);
          const totalBuyInValue = p.buyIns * buyInValue;
          const totalRebuyValue = p.rebuys * rebuyValue;
          const placePrize =
            p.placement === "1" ? prizeCache.p1 :
            p.placement === "2" ? prizeCache.p2 :
            p.placement === "3" ? prizeCache.p3 : 0;
          const resultado = placePrize - p.totalSpent;

          const lineColor = getPlacementColor(p.placement);
          const isWinner = p.placement === "1" || p.placement === "2" || p.placement === "3";

          const baseText =
            name +
            " - BI: " + p.buyIns + " (" + formatMoney(totalBuyInValue) + ")" +
            " | RB: " + p.rebuys + " (" + formatMoney(totalRebuyValue) + ")" +
            " | GASTO: " + formatMoney(p.totalSpent);

          let prefixText = baseText;
          if (placePrize > 0) {
            prefixText += " | PRÃŠMIO: " + formatMoney(placePrize);
          }

          let resultSegment;
          let resultColor = "#111111";
          if (resultado > 0) {
            resultSegment = " | Resultado: + " + formatMoney(Math.abs(resultado));
            resultColor = "#34c759";
          } else if (resultado < 0) {
            resultSegment = " | Resultado: - " + formatMoney(Math.abs(resultado));
            resultColor = "#ff3b30";
          } else {
            resultSegment = " | Resultado: " + formatMoney(0);
          }

          ctx.fillStyle = isWinner ? lineColor : "#111111";
          ctx.fillText(prefixText, 40, y);
          const prefixWidth = ctx.measureText(prefixText).width;

          ctx.fillStyle = resultColor;
          ctx.fillText(resultSegment, 40 + prefixWidth, y);

          y += 22;
        });
      }
    }

    pngCardBtn.addEventListener("click", () => {
      drawSummaryCard();
      const dataUrl = summaryCanvas.toDataURL("image/png");

      const link = document.createElement("a");
      link.href = dataUrl;
      link.download = "poker_resumo.png";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });

    // Listeners de settings
    buyInInput.addEventListener("change", () => {
      state.settings.buyInValue = toNumber(buyInInput.value, 0);
      saveState(state);
      renderPlayers();
      recalc();
    });

    rebuyInput.addEventListener("change", () => {
      state.settings.rebuyValue = toNumber(rebuyInput.value, 0);
      saveState(state);
      renderPlayers();
      recalc();
    });

    buyInChipsInput.addEventListener("change", () => {
      state.settings.buyInChips = toNumber(buyInChipsInput.value, 0);
      saveState(state);
    });

    rebuyChipsInput.addEventListener("change", () => {
      state.settings.rebuyChips = toNumber(rebuyChipsInput.value, 0);
      saveState(state);
    });

    function updatePrizeSetting() {
      state.settings.prize1 = toNumber(prize1Input.value, 0);
      state.settings.prize2 = toNumber(prize2Input.value, 0);
      state.settings.prize3 = toNumber(prize3Input.value, 0);
      saveState(state);
      updatePrizeSumWarning();
      recalc();
    }

    prize1Input.addEventListener("change", updatePrizeSetting);
    prize2Input.addEventListener("change", updatePrizeSetting);
    prize3Input.addEventListener("change", updatePrizeSetting);

    document.getElementById("resetSession").addEventListener("click", () => {
      if (!confirm("Zerar todos os jogadores e configuraÃ§Ãµes?")) return;
      state = defaultState();
      saveState(state);
      renderSettings();
      renderPlayers();
      recalc();
    });

    // InicializaÃ§Ã£o
    renderSettings();
    renderPlayers();
    recalc();

    // PWA service worker (versionado)
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker
          .register("sw.js?v=" + APP_VERSION)
          .catch((err) => console.error("SW registration failed", err));
      });
    }
  </script>
</body>
</html>
