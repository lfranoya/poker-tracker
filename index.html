<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Poker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- PWA manifest -->
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#ffffff" />

  <!-- iOS specific -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="Poker Tracker" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />

  <style>
    * {
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui, sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      background: #f3f3f5;
      color: #111;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      transition: background 0.2s, color 0.2s;
    }

    header {
      padding: 10px 14px;
      background: #ffffff;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 10;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    header h1 {
      font-size: 20px;
      margin: 0;
    }

    .theme-toggle {
      border-radius: 999px;
      border: 1px solid #d0d0d4;
      background: #f2f2f7;
      padding: 6px 10px;
      font-size: 16px;
      cursor: pointer;
      min-width: 40px;
    }

    main {
      padding: 16px;
      flex: 1;
      max-width: 900px;
      width: 100%;
      margin: 0 auto 8px;
    }

    .card {
      background: #ffffff;
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.07);
      transition: background 0.2s, box-shadow 0.2s, border-color 0.2s;
    }

    .card-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    label {
      font-size: 13px;
      display: block;
      margin-bottom: 4px;
      color: #555;
    }

    input[type="number"],
    input[type="text"] {
      width: 100%;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #d0d0d4;
      font-size: 14px;
      background: #ffffff;
      color: inherit;
    }

    input[type="number"]:focus,
    input[type="text"]:focus {
      outline: none;
      border-color: #007aff;
    }

    .row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }

    .row > div {
      flex: 1;
      min-width: 90px;
    }

    .player-head {
      display: grid;
      grid-template-columns: 1.3fr 0.9fr 0.9fr 1fr 1.1fr;
      gap: 6px;
      font-size: 11px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .player-row {
      display: grid;
      grid-template-columns: 1.3fr 0.9fr 0.9fr 1fr 1.1fr;
      gap: 6px;
      align-items: center;
      margin-bottom: 6px;
      padding: 4px 4px;
      border-radius: 8px;
      border: 1px solid transparent;
      transition: background 0.15s, border-color 0.15s;
    }

    .player-row.biggest {
      border-color: #ff9500;
      background: rgba(255,149,0,0.08);
    }

    .player-row.smallest {
      border-color: #34c759;
      background: rgba(52,199,89,0.08);
    }

    .counter {
      display: flex;
      align-items: center;
      gap: 4px;
      justify-content: center;
    }

    .counter button {
      width: 28px;
      height: 28px;
      border-radius: 6px;
      border: none;
      font-size: 18px;
      font-weight: 600;
      background: #f2f2f7;
      cursor: pointer;
      padding: 0;
    }

    .counter input {
      width: 48px;
      text-align: center;
      padding: 4px;
      border-radius: 6px;
      border: 1px solid #d0d0d4;
      font-size: 14px;
      background: #ffffff;
      color: inherit;
    }

    .spent-label {
      font-size: 14px;
      text-align: right;
      padding-right: 4px;
      min-width: 80px;
    }

    .summary-item {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      margin-bottom: 4px;
    }

    .summary-item strong {
      font-weight: 600;
    }

    .total-pot {
      font-size: 18px;
      font-weight: 700;
      margin-top: 6px;
    }

    .btn {
      border: none;
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
    }

    .btn-primary {
      background: #007aff;
      color: white;
      width: 100%;
      margin-top: 8px;
    }

    .btn-danger {
      background: #ff3b30;
      color: white;
      width: 100%;
      margin-top: 8px;
    }

    .small-note {
      font-size: 11px;
      color: #888;
      margin-top: 4px;
    }

    .warning {
      color: #c00;
      font-size: 12px;
      margin-top: 4px;
    }

    footer {
      font-size: 11px;
      text-align: center;
      padding: 6px 12px 10px;
      color: #666;
    }

    .net-profit {
      color: #34c759;
      font-weight: 600;
      font-size: 13px;
      text-align: right;
    }

    .net-loss {
      color: #ff3b30;
      font-weight: 600;
      font-size: 13px;
      text-align: right;
    }

    .net-neutral {
      color: #888888;
      font-weight: 500;
      font-size: 13px;
      text-align: right;
    }

    /* Dark mode */
    body.dark {
      background: #111111;
      color: #f5f5f5;
    }

    body.dark header {
      background: #1c1c1e;
      box-shadow: 0 1px 3px rgba(0,0,0,0.7);
    }

    body.dark .card {
      background: #1c1c1e;
      box-shadow: 0 1px 3px rgba(0,0,0,0.7);
      border: 1px solid #2c2c2e;
    }

    body.dark input[type="number"],
    body.dark input[type="text"] {
      background: #2c2c2e;
      border-color: #3a3a3c;
      color: #f5f5f5;
    }

    body.dark .counter button {
      background: #2c2c2e;
      color: #f5f5f5;
    }

    body.dark .btn-primary {
      background: #0a84ff;
    }

    body.dark .btn-danger {
      background: #ff453a;
    }

    body.dark .small-note {
      color: #aaa;
    }

    body.dark footer {
      color: #999;
    }

    body.dark .player-row.biggest {
      background: rgba(255,159,10,0.25);
      border-color: #ff9f0a;
    }

    body.dark .player-row.smallest {
      background: rgba(48,209,88,0.3);
      border-color: #30d158;
    }

    @media (max-width: 480px) {
      .player-head,
      .player-row {
        grid-template-columns: 1.2fr 0.8fr 0.8fr 1fr 1.1fr;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Poker</h1>
    <button id="themeToggle" class="theme-toggle" aria-label="Alternar tema">üåô</button>
  </header>

  <main>
    <!-- Session settings -->
    <section class="card">
      <div class="card-title">Configura√ß√µes da rodada</div>
      <div class="row">
        <div>
          <label for="buyInValue">Valor do buy-in (R$)</label>
          <input id="buyInValue" type="number" min="0" step="0.01" inputmode="decimal" />
        </div>
        <div>
          <label for="rebuyValue">Valor do rebuy (R$)</label>
          <input id="rebuyValue" type="number" min="0" step="0.01" inputmode="decimal" />
        </div>
      </div>

      <div class="row" style="margin-top:4px;">
        <div>
          <label for="tableName">Nome da mesa / evento</label>
          <input id="tableName" type="text" placeholder="Ex: Poker Quinta, Mesa Miami..." />
        </div>
      </div>

      <div style="margin-top:8px;">
        <div class="card-title" style="font-size:14px;margin-bottom:4px;">Distribui√ß√£o de pr√™mios (%)</div>
        <div class="row">
          <div>
            <label for="prize1">1¬∫ lugar</label>
            <input id="prize1" type="number" min="0" max="100" step="1" />
          </div>
          <div>
            <label for="prize2">2¬∫ lugar</label>
            <input id="prize2" type="number" min="0" max="100" step="1" />
          </div>
          <div>
            <label for="prize3">3¬∫ lugar</label>
            <input id="prize3" type="number" min="0" max="100" step="1" />
          </div>
        </div>
        <div id="prizeSumWarning" class="warning" style="display:none;"></div>
        <div class="small-note">Dica: normalmente a soma d√° 100%.</div>
      </div>

      <button id="resetSession" class="btn btn-danger">Zerar rodada</button>
    </section>

    <!-- Players -->
    <section class="card">
      <div class="card-title">Jogadores (at√© 10)</div>
      <div class="player-head">
        <div>Jogador</div>
        <div>Buy-ins</div>
        <div>Rebuys</div>
        <div>Total gasto</div>
        <div>Pos/Res</div>
      </div>
      <div id="playersContainer"></div>
      <div class="small-note">
        Os jogadores s√£o ordenados pelo total gasto (do maior para o menor).
      </div>
    </section>

    <!-- Totals & prizes -->
    <section class="card">
      <div class="card-title">Totais & pr√™mios</div>
      <div class="summary-item">
        <span>Total de buy-ins</span><strong id="totalBuyIns">0</strong>
      </div>
      <div class="summary-item">
        <span>Total de rebuys</span><strong id="totalRebuys">0</strong>
      </div>
      <div class="summary-item">
        <span>Arrecadado em buy-ins</span><strong id="totalFromBuyIns">R$ 0,00</strong>
      </div>
      <div class="summary-item">
        <span>Arrecadado em rebuys</span><strong id="totalFromRebuys">R$ 0,00</strong>
      </div>
      <div class="total-pot">
        Pote total: <span id="totalPot">R$ 0,00</span>
      </div>

      <hr style="margin:12px 0;border:none;border-top:1px solid #eee;">

      <div class="summary-item">
        <span>1¬∫ lugar</span><strong id="prize1Amount">R$ 0,00</strong>
      </div>
      <div class="summary-item">
        <span>2¬∫ lugar</span><strong id="prize2Amount">R$ 0,00</strong>
      </div>
      <div class="summary-item">
        <span>3¬∫ lugar</span><strong id="prize3Amount">R$ 0,00</strong>
      </div>

      <hr style="margin:12px 0;border:none;border-top:1px dashed #ddd;">

      <div class="card-title" style="font-size:14px;margin-bottom:4px;">
        Resumo da rodada
      </div>

      <textarea id="summaryText" readonly
        style="width:100%;min-height:120px;border-radius:8px;border:1px solid #d0d0d4;
               padding:6px 8px;font-size:13px;resize:vertical;">
      </textarea>

      <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;">
        <button id="copySummary" class="btn"
          style="flex:1;min-width:120px;background:#34c759;color:white;">
          Copiar resumo
        </button>
        <a id="whatsSummary" class="btn"
          style="flex:1;min-width:120px;text-align:center;text-decoration:none;background:#25d366;color:white;">
          WhatsApp
        </a>
      </div>

      <button id="exportImageBtn" class="btn"
        style="margin-top:8px;background:#111;color:#fff;width:100%;">
        Exportar cart√£o (PNG)
      </button>

      <button id="recalcBtn" class="btn btn-primary">Recalcular</button>
      <div class="small-note">Tudo √© recalculado automaticamente, mas voc√™ pode tocar em ‚ÄúRecalcular‚Äù a qualquer momento.</div>
    </section>
  </main>

  <footer>
    Dados ficam somente neste dispositivo ¬∑ Funciona offline ap√≥s o primeiro acesso
  </footer>

  <script>
    const STORAGE_KEY = "poker_tracker_state_v3";
    const THEME_KEY = "poker_tracker_theme";

    // Formata√ß√£o de moeda BRL
    let moneyFormatter;
    try {
      moneyFormatter = new Intl.NumberFormat("pt-BR", {
        style: "currency",
        currency: "BRL",
        minimumFractionDigits: 2,
      });
    } catch (e) {
      moneyFormatter = {
        format(v) {
          return "R$ " + Number(v).toFixed(2).replace(".", ",");
        },
      };
    }

    function formatMoney(v) {
      return moneyFormatter.format(v || 0);
    }

    function formatDateBR(d) {
      return d.toLocaleDateString("pt-BR", {
        day: "2-digit",
        month: "2-digit",
        year: "numeric",
      });
    }

    function defaultState() {
      return {
        settings: {
          buyInValue: 50,
          rebuyValue: 50,
          prize1: 50,
          prize2: 30,
          prize3: 20,
          tableName: "Poker Night",
        },
        players: Array.from({ length: 10 }, (_, i) => ({
          id: i,
          name: "Jogador " + (i + 1),
          buyIns: 0,
          rebuys: 0,
          position: 0,
        })),
      };
    }

    function loadState() {
      try {
        const data = localStorage.getItem(STORAGE_KEY);
        if (!data) return defaultState();
        const parsed = JSON.parse(data);

        let players = parsed.players;
        if (!Array.isArray(players) || players.length !== 10) {
          players = defaultState().players;
        } else {
          players = players.map((p, i) => ({
            id: p.id ?? i,
            name: (p.name && p.name.trim()) ? p.name : ("Jogador " + (i + 1)),
            buyIns: p.buyIns ?? 0,
            rebuys: p.rebuys ?? 0,
            position: p.position ?? 0,
          }));
        }

        return {
          settings: {
            buyInValue: parsed.settings?.buyInValue ?? 50,
            rebuyValue: parsed.settings?.rebuyValue ?? 50,
            prize1: parsed.settings?.prize1 ?? 50,
            prize2: parsed.settings?.prize2 ?? 30,
            prize3: parsed.settings?.prize3 ?? 20,
            tableName: parsed.settings?.tableName ?? "Poker Night",
          },
          players,
        };
      } catch (e) {
        console.error("Error loading state", e);
        return defaultState();
      }
    }

    function saveState(state) {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      } catch (e) {
        console.error("Error saving state", e);
      }
    }

    function toNumber(v, def = 0) {
      if (v === null || v === undefined) return def;
      const normalized = String(v).replace(",", ".");
      const n = parseFloat(normalized);
      return isNaN(n) ? def : n;
    }

    let state = loadState();

    // Elements
    const buyInInput = document.getElementById("buyInValue");
    const rebuyInput = document.getElementById("rebuyValue");
    const prize1Input = document.getElementById("prize1");
    const prize2Input = document.getElementById("prize2");
    const prize3Input = document.getElementById("prize3");
    const prizeSumWarning = document.getElementById("prizeSumWarning");
    const playersContainer = document.getElementById("playersContainer");
    const tableNameInput = document.getElementById("tableName");

    const totalBuyInsEl = document.getElementById("totalBuyIns");
    const totalRebuysEl = document.getElementById("totalRebuys");
    const totalFromBuyInsEl = document.getElementById("totalFromBuyIns");
    const totalFromRebuysEl = document.getElementById("totalFromRebuys");
    const totalPotEl = document.getElementById("totalPot");
    const prize1AmountEl = document.getElementById("prize1Amount");
    const prize2AmountEl = document.getElementById("prize2Amount");
    const prize3AmountEl = document.getElementById("prize3Amount");

    const summaryTextEl = document.getElementById("summaryText");
    const copySummaryBtn = document.getElementById("copySummary");
    const whatsSummaryLink = document.getElementById("whatsSummary");
    const exportImageBtn = document.getElementById("exportImageBtn");

    const themeToggleBtn = document.getElementById("themeToggle");

    // THEME
    function applyTheme(theme) {
      if (theme === "dark") {
        document.body.classList.add("dark");
        themeToggleBtn.textContent = "‚òÄÔ∏è";
      } else {
        document.body.classList.remove("dark");
        themeToggleBtn.textContent = "üåô";
      }
    }

    function loadTheme() {
      const stored = localStorage.getItem(THEME_KEY);
      const theme = stored === "dark" ? "dark" : "light";
      applyTheme(theme);
    }

    function toggleTheme() {
      const isDark = document.body.classList.contains("dark");
      const newTheme = isDark ? "light" : "dark";
      applyTheme(newTheme);
      localStorage.setItem(THEME_KEY, newTheme);
    }

    themeToggleBtn.addEventListener("click", toggleTheme);
    loadTheme();

    function renderSettings() {
      buyInInput.value = state.settings.buyInValue;
      rebuyInput.value = state.settings.rebuyValue;
      prize1Input.value = state.settings.prize1;
      prize2Input.value = state.settings.prize2;
      prize3Input.value = state.settings.prize3;
      tableNameInput.value = state.settings.tableName;
      updatePrizeSumWarning();
    }

    function updatePrizeSumWarning() {
      const s = state.settings;
      const sum =
        toNumber(s.prize1) + toNumber(s.prize2) + toNumber(s.prize3);
      if (sum !== 100) {
        prizeSumWarning.style.display = "block";
        prizeSumWarning.textContent =
          "Aten√ß√£o: a soma dos pr√™mios √© " + sum + "% (n√£o 100%).";
      } else {
        prizeSumWarning.style.display = "none";
      }
    }

    function computeTotalsAndPrizes() {
      const buyInValue = toNumber(state.settings.buyInValue);
      const rebuyValue = toNumber(state.settings.rebuyValue);

      let totalBuyIns = 0;
      let totalRebuys = 0;

      state.players.forEach((p) => {
        totalBuyIns += toNumber(p.buyIns);
        totalRebuys += toNumber(p.rebuys);
      });

      const totalFromBuyIns = totalBuyIns * buyInValue;
      const totalFromRebuys = totalRebuys * rebuyValue;
      const totalPot = totalFromBuyIns + totalFromRebuys;

      const p1 = toNumber(state.settings.prize1);
      const p2 = toNumber(state.settings.prize2);
      const p3 = toNumber(state.settings.prize3);

      let prize1Amount = (totalPot * p1) / 100;
      let prize2Amount = (totalPot * p2) / 100;
      let prize3Amount = (totalPot * p3) / 100;

      const totalPrizes = prize1Amount + prize2Amount + prize3Amount;
      const diff = totalPot - totalPrizes;
      prize1Amount += diff; // joga res√≠duo no 1¬∫ lugar

      return {
        buyInValue,
        rebuyValue,
        totalBuyIns,
        totalRebuys,
        totalFromBuyIns,
        totalFromRebuys,
        totalPot,
        prize1Amount,
        prize2Amount,
        prize3Amount,
        p1,
        p2,
        p3,
      };
    }

    function updatePlayer(originalIndex, newBuyIns, newRebuys) {
      const player = state.players[originalIndex];
      player.buyIns = Math.max(0, Math.floor(toNumber(newBuyIns, 0)));
      player.rebuys = Math.max(0, Math.floor(toNumber(newRebuys, 0)));
      saveState(state);
      renderPlayers();
      recalc();
    }

    function setPositionForPlayer(playerIndex, newPos) {
      // Garante exclusividade: s√≥ um jogador por posi√ß√£o (1,2,3)
      state.players.forEach((pl, i) => {
        if (i !== playerIndex && pl.position === newPos && newPos !== 0) {
          pl.position = 0;
        }
      });
      state.players[playerIndex].position = newPos;
      saveState(state);
      renderPlayers();
      recalc();
    }

    function renderPlayers() {
      playersContainer.innerHTML = "";

      const {
        buyInValue,
        rebuyValue,
        prize1Amount,
        prize2Amount,
        prize3Amount,
      } = computeTotalsAndPrizes();

      const playersWithIndex = state.players.map((p, index) => {
        const totalSpent = p.buyIns * buyInValue + p.rebuys * rebuyValue;
        let prize = 0;
        if (p.position === 1) prize = prize1Amount;
        if (p.position === 2) prize = prize2Amount;
        if (p.position === 3) prize = prize3Amount;
        const net = prize - totalSpent;
        return { ...p, index, totalSpent, prize, net };
      });

      const totals = playersWithIndex.map((p) => p.totalSpent);
      const maxSpent = Math.max(...totals, 0);
      const positiveTotals = totals.filter((v) => v > 0);
      const minSpent =
        positiveTotals.length > 0 ? Math.min(...positiveTotals) : 0;

      // Ordena do que mais gastou para o que menos gastou
      playersWithIndex.sort((a, b) => b.totalSpent - a.totalSpent);

      playersWithIndex.forEach((p) => {
        const row = document.createElement("div");
        row.className = "player-row";

        if (p.totalSpent > 0 && p.totalSpent === maxSpent) {
          row.classList.add("biggest");
        }
        if (p.totalSpent > 0 && p.totalSpent === minSpent && maxSpent !== minSpent) {
          row.classList.add("smallest");
        }

        // Nome
        const nameDiv = document.createElement("div");
        const nameInput = document.createElement("input");
        nameInput.type = "text";
        nameInput.placeholder = "Jogador " + (p.index + 1);
        nameInput.value = p.name || "";
        nameInput.addEventListener("input", () => {
          state.players[p.index].name = nameInput.value;
          saveState(state);
          recalc();
        });
        nameDiv.appendChild(nameInput);

        // Buy-ins
        const buyDiv = document.createElement("div");
        const buyCounter = document.createElement("div");
        buyCounter.className = "counter";

        const buyMinus = document.createElement("button");
        buyMinus.textContent = "‚Äì";

        const buyInputEl = document.createElement("input");
        buyInputEl.type = "number";
        buyInputEl.min = "0";
        buyInputEl.step = "1";
        buyInputEl.value = p.buyIns;

        const buyPlus = document.createElement("button");
        buyPlus.textContent = "+";

        buyCounter.appendChild(buyMinus);
        buyCounter.appendChild(buyInputEl);
        buyCounter.appendChild(buyPlus);
        buyDiv.appendChild(buyCounter);

        // Rebuys
        const rebuyDiv = document.createElement("div");
        const rebuyCounter = document.createElement("div");
        rebuyCounter.className = "counter";

        const rebuyMinus = document.createElement("button");
        rebuyMinus.textContent = "‚Äì";

        const rebuyInputEl = document.createElement("input");
        rebuyInputEl.type = "number";
        rebuyInputEl.min = "0";
        rebuyInputEl.step = "1";
        rebuyInputEl.value = p.rebuys;

        const rebuyPlus = document.createElement("button");
        rebuyPlus.textContent = "+";

        rebuyCounter.appendChild(rebuyMinus);
        rebuyCounter.appendChild(rebuyInputEl);
        rebuyCounter.appendChild(rebuyPlus);
        rebuyDiv.appendChild(rebuyCounter);

        // Total gasto
        const spentDiv = document.createElement("div");
        const spentLabel = document.createElement("div");
        spentLabel.className = "spent-label";
        spentLabel.textContent = formatMoney(p.totalSpent);
        spentDiv.appendChild(spentLabel);

        // Posi√ß√£o + Resultado
        const resultDiv = document.createElement("div");
        resultDiv.style.display = "flex";
        resultDiv.style.flexDirection = "column";
        resultDiv.style.alignItems = "stretch";
        resultDiv.style.gap = "2px";

        const posSelect = document.createElement("select");
        posSelect.style.width = "100%";
        posSelect.style.borderRadius = "6px";
        posSelect.style.border = "1px solid #d0d0d4";
        posSelect.style.padding = "2px 4px";
        posSelect.style.fontSize = "12px";

        const optNone = document.createElement("option");
        optNone.value = "0";
        optNone.textContent = "-";
        const opt1 = document.createElement("option");
        opt1.value = "1";
        opt1.textContent = "1¬∫";
        const opt2 = document.createElement("option");
        opt2.value = "2";
        opt2.textContent = "2¬∫";
        const opt3 = document.createElement("option");
        opt3.value = "3";
        opt3.textContent = "3¬∫";

        posSelect.appendChild(optNone);
        posSelect.appendChild(opt1);
        posSelect.appendChild(opt2);
        posSelect.appendChild(opt3);
        posSelect.value = String(p.position || 0);

        posSelect.addEventListener("change", () => {
          const newPos = parseInt(posSelect.value, 10) || 0;
          setPositionForPlayer(p.index, newPos);
        });

        const netLabel = document.createElement("div");
        const absNet = Math.abs(p.net || 0);
        const netMoney = formatMoney(absNet);
        if (p.net > 0) {
          netLabel.textContent = "+" + netMoney;
          netLabel.className = "net-profit";
        } else if (p.net < 0) {
          netLabel.textContent = "-" + netMoney;
          netLabel.className = "net-loss";
        } else {
          netLabel.textContent = netMoney;
          netLabel.className = "net-neutral";
        }

        resultDiv.appendChild(posSelect);
        resultDiv.appendChild(netLabel);

        row.appendChild(nameDiv);
        row.appendChild(buyDiv);
        row.appendChild(rebuyDiv);
        row.appendChild(spentDiv);
        row.appendChild(resultDiv);

        playersContainer.appendChild(row);

        // Eventos de buy-in/rebuy
        buyMinus.addEventListener("click", () => {
          updatePlayer(p.index, state.players[p.index].buyIns - 1, state.players[p.index].rebuys);
        });
        buyPlus.addEventListener("click", () => {
          updatePlayer(p.index, state.players[p.index].buyIns + 1, state.players[p.index].rebuys);
        });
        rebuyMinus.addEventListener("click", () => {
          updatePlayer(p.index, state.players[p.index].buyIns, state.players[p.index].rebuys - 1);
        });
        rebuyPlus.addEventListener("click", () => {
          updatePlayer(p.index, state.players[p.index].buyIns, state.players[p.index].rebuys + 1);
        });

        buyInputEl.addEventListener("change", () => {
          updatePlayer(p.index, buyInputEl.value, state.players[p.index].rebuys);
        });
        rebuyInputEl.addEventListener("change", () => {
          updatePlayer(p.index, state.players[p.index].buyIns, rebuyInputEl.value);
        });
      });
    }

    function buildRanking(players, prize1Amount, prize2Amount, prize3Amount) {
      const list = players.map((p, index) => {
        const name = p.name || `Jogador ${index + 1}`;
        let prize = 0;
        if (p.position === 1) prize = prize1Amount;
        if (p.position === 2) prize = prize2Amount;
        if (p.position === 3) prize = prize3Amount;

        return {
          name,
          prize,
          position: p.position,
        };
      });

      list.sort((a, b) => (a.position || 999) - (b.position || 999));

      return list
        .filter(p => p.position) // s√≥ quem tem posi√ß√£o
        .map(p => {
          let emoji = "";
          if (p.position === 1) emoji = "ü•á";
          else if (p.position === 2) emoji = "ü•à";
          else if (p.position === 3) emoji = "ü•â";

          const posLabel = `${p.position}¬∫`;
          return `${emoji} ${posLabel} ‚Äî ${p.name} (${formatMoney(p.prize || 0)})`;
        });
    }

    function buildShortSummary(prize1Amount, prize2Amount, prize3Amount) {
      const { totalPot } = computeTotalsAndPrizes();
      const dateStr = formatDateBR(new Date());
      const tableName = state.settings.tableName || "Poker Night";

      const rankingLines = buildRanking(state.players, prize1Amount, prize2Amount, prize3Amount);
      const rankingShort = rankingLines.slice(0, 3).join(" | ") || "sem vencedores definidos";

      return `${tableName} ‚Äì ${dateStr}
Pote: ${formatMoney(totalPot)}
Ranking: ${rankingShort}`;
    }

    function buildSummary() {
      const {
        buyInValue,
        rebuyValue,
        totalBuyIns,
        totalRebuys,
        totalFromBuyIns,
        totalFromRebuys,
        totalPot,
        prize1Amount,
        prize2Amount,
        prize3Amount,
        p1,
        p2,
        p3,
      } = computeTotalsAndPrizes();

      const playersLines = [];
      const today = new Date();
      const dateStr = formatDateBR(today);
      const tableName = state.settings.tableName || "Poker Night";

      state.players.forEach((p, i) => {
        const name = p.name?.trim() || `Jogador ${i + 1}`;
        const buyIns = toNumber(p.buyIns);
        const rebuys = toNumber(p.rebuys);
        if (buyIns === 0 && rebuys === 0 && !p.name) return;

        const spent = buyIns * buyInValue + rebuys * rebuyValue;

        const buyInValueTotal = buyIns * buyInValue;
        const rebuyValueTotal = rebuys * rebuyValue;

        const biText = `${buyIns}√óBI (${formatMoney(buyInValueTotal)})`;
        const rbText = `${rebuys}√óRB (${formatMoney(rebuyValueTotal)})`;

        let prize = 0;
        if (p.position === 1) prize = prize1Amount;
        if (p.position === 2) prize = prize2Amount;
        if (p.position === 3) prize = prize3Amount;

        const net = prize - spent;
        const absNet = Math.abs(net);
        const netMoney = formatMoney(absNet);
        const netLabel = net > 0 ? `+${netMoney}` : net < 0 ? `-${netMoney}` : netMoney;

        const posLabel = p.position ? `${p.position}¬∫` : "-";

        playersLines.push(
          `${name} ‚Äî ${biText} | ${rbText} | Total: ${formatMoney(spent)} | ` +
          `Posi√ß√£o: ${posLabel} | Pr√™mio: ${formatMoney(prize)} | Resultado: ${netLabel}`
        );
      });

      const lines = [];

      lines.push(`üÉè ${tableName} ‚Äì resumo da rodada`);
      lines.push(`Data: ${dateStr}`);
      lines.push("");
      lines.push(`Buy-in: ${formatMoney(buyInValue)} | Rebuy: ${formatMoney(rebuyValue)}`);
      lines.push(`Total buy-ins: ${totalBuyIns} (${formatMoney(totalFromBuyIns)})`);
      lines.push(`Total rebuys: ${totalRebuys} (${formatMoney(totalFromRebuys)})`);
      lines.push(`Pote total: ${formatMoney(totalPot)}`);
      lines.push("");
      lines.push("Pr√™mios:");
      lines.push(`1¬∫ lugar (${p1}%): ${formatMoney(prize1Amount)}`);
      lines.push(`2¬∫ lugar (${p2}%): ${formatMoney(prize2Amount)}`);
      lines.push(`3¬∫ lugar (${p3}%): ${formatMoney(prize3Amount)}`);
      lines.push("");

      const rankingLines = buildRanking(state.players, prize1Amount, prize2Amount, prize3Amount);
      if (rankingLines.length) {
        lines.push("Ranking final:");
        lines.push(...rankingLines);
        lines.push("");
      }

      if (playersLines.length) {
        lines.push("Jogadores:");
        lines.push(...playersLines);
        lines.push("");
      }

      lines.push("Resumo curto (WhatsApp):");
      lines.push(buildShortSummary(prize1Amount, prize2Amount, prize3Amount));

      return lines.join("\n");
    }

    function recalc() {
      const {
        totalBuyIns,
        totalRebuys,
        totalFromBuyIns,
        totalFromRebuys,
        totalPot,
        prize1Amount,
        prize2Amount,
        prize3Amount,
      } = computeTotalsAndPrizes();

      totalBuyInsEl.textContent = totalBuyIns;
      totalRebuysEl.textContent = totalRebuys;
      totalFromBuyInsEl.textContent = formatMoney(totalFromBuyIns);
      totalFromRebuysEl.textContent = formatMoney(totalFromRebuys);
      totalPotEl.textContent = formatMoney(totalPot);

      prize1AmountEl.textContent = formatMoney(prize1Amount);
      prize2AmountEl.textContent = formatMoney(prize2Amount);
      prize3AmountEl.textContent = formatMoney(prize3Amount);

      const summary = buildSummary();
      if (summaryTextEl) {
        summaryTextEl.value = summary;
      }
      if (whatsSummaryLink) {
        whatsSummaryLink.href = "https://wa.me/?text=" + encodeURIComponent(summary);
      }
    }

    // Listeners settings
    buyInInput.addEventListener("change", () => {
      state.settings.buyInValue = toNumber(buyInInput.value, 0);
      saveState(state);
      renderPlayers();
      recalc();
    });

    rebuyInput.addEventListener("change", () => {
      state.settings.rebuyValue = toNumber(rebuyInput.value, 0);
      saveState(state);
      renderPlayers();
      recalc();
    });

    function updatePrizeSetting() {
      state.settings.prize1 = toNumber(prize1Input.value, 0);
      state.settings.prize2 = toNumber(prize2Input.value, 0);
      state.settings.prize3 = toNumber(prize3Input.value, 0);
      saveState(state);
      updatePrizeSumWarning();
      renderPlayers();
      recalc();
    }

    prize1Input.addEventListener("change", updatePrizeSetting);
    prize2Input.addEventListener("change", updatePrizeSetting);
    prize3Input.addEventListener("change", updatePrizeSetting);

    tableNameInput.addEventListener("input", () => {
      state.settings.tableName = tableNameInput.value;
      saveState(state);
      recalc();
    });

    document.getElementById("recalcBtn").addEventListener("click", recalc);

    document.getElementById("resetSession").addEventListener("click", () => {
      if (!confirm("Zerar todos os jogadores e configura√ß√µes?")) return;
      state = defaultState();
      saveState(state);
      renderSettings();
      renderPlayers();
      recalc();
    });

    if (copySummaryBtn) {
      copySummaryBtn.addEventListener("click", async () => {
        const text = summaryTextEl?.value || "";
        if (!text.trim()) return;

        try {
          if (navigator.clipboard && navigator.clipboard.writeText) {
            await navigator.clipboard.writeText(text);
            alert("Resumo copiado para a √°rea de transfer√™ncia.");
          } else {
            summaryTextEl.select();
            document.execCommand("copy");
            alert("Resumo copiado (modo compatibilidade).");
          }
        } catch (e) {
          console.error(e);
          alert("N√£o foi poss√≠vel copiar o resumo.");
        }
      });
    }

    if (exportImageBtn) {
      exportImageBtn.addEventListener("click", () => {
        const text = summaryTextEl?.value || "";
        if (!text.trim()) {
          alert("N√£o h√° resumo para exportar.");
          return;
        }

        const canvas = document.createElement("canvas");
        canvas.width = 1080;
        canvas.height = 1350;
        const ctx = canvas.getContext("2d");

        // Fundo
        ctx.fillStyle = "#111111";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Cart√£o central
        const margin = 80;
        const cardX = margin;
        const cardY = margin + 40;
        const cardW = canvas.width - margin * 2;
        const cardH = canvas.height - margin * 2 - 40;

        ctx.fillStyle = "#1e1e20";
        ctx.roundRect(cardX, cardY, cardW, cardH, 40);
        ctx.fill();

        // T√≠tulo
        ctx.fillStyle = "#ffffff";
        ctx.font = "bold 48px -apple-system, system-ui, sans-serif";
        const tableName = state.settings.tableName || "Poker Night";
        const title = "Resumo ‚Äì " + tableName;
        const titleWidth = ctx.measureText(title).width;
        ctx.fillText(title, canvas.width / 2 - titleWidth / 2, cardY + 70);

        // Texto do resumo
        ctx.font = "28px -apple-system, system-ui, sans-serif";
        ctx.fillStyle = "#f5f5f7";
        const lines = text.split("\n");
        const maxTextWidth = cardW - 60;
        let y = cardY + 120;

        function drawWrapped(line) {
          const words = line.split(" ");
          let current = "";
          for (let w of words) {
            const test = current ? current + " " + w : w;
            if (ctx.measureText(test).width > maxTextWidth) {
              ctx.fillText(current, cardX + 30, y);
              y += 36;
              current = w;
            } else {
              current = test;
            }
          }
          if (current) {
            ctx.fillText(current, cardX + 30, y);
            y += 36;
          }
        }

        for (const line of lines) {
          if (!line.trim()) {
            y += 20;
            continue;
          }
          drawWrapped(line);
          if (y > cardY + cardH - 40) break;
        }

        // Baixar imagem
        const dataUrl = canvas.toDataURL("image/png");
        const a = document.createElement("a");
        a.href = dataUrl;
        a.download = "poker-resumo.png";
        a.click();
      });
    }

    // Inicializa√ß√£o
    renderSettings();
    renderPlayers();
    recalc();

    // PWA service worker
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker
          .register("sw.js")
          .catch((err) => console.error("SW registration failed", err));
      });
    }
  </script>
</body>
</html>
