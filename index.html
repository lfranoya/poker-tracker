<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Poker Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- PWA manifest -->
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#ffffff" />

  <!-- iOS specific -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="Poker Tracker" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />

  <style>
    * {
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui, sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      background: #f3f3f5;
      color: #111;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      transition: background 0.2s, color 0.2s;
    }

    header {
      padding: 10px 14px;
      background: #ffffff;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 10;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    header h1 {
      font-size: 20px;
      margin: 0;
    }

    .theme-toggle {
      border-radius: 999px;
      border: 1px solid #d0d0d4;
      background: #f2f2f7;
      padding: 6px 10px;
      font-size: 16px;
      cursor: pointer;
      min-width: 40px;
    }

    main {
      padding: 16px;
      flex: 1;
      max-width: 900px;
      width: 100%;
      margin: 0 auto 8px;
    }

    .card {
      background: #ffffff;
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.07);
      transition: background 0.2s, box-shadow 0.2s, border-color 0.2s;
    }

    .card-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 8px;
      display: flex;
      align-items: baseline;
      gap: 6px;
    }

    .results-date {
      font-size: 13px;
      font-weight: 400;
      color: #666;
    }

    label {
      font-size: 13px;
      display: block;
      margin-bottom: 4px;
      color: #555;
    }

    input[type="number"],
    input[type="text"] {
      width: 100%;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #d0d0d4;
      font-size: 14px;
      background: #ffffff;
      color: inherit;
    }

    input[type="number"]:focus,
    input[type="text"]:focus {
      outline: none;
      border-color: #007aff;
    }

    .row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }

    .row > div {
      flex: 1;
      min-width: 90px;
    }

    .player-head {
      display: grid;
      grid-template-columns: 1.3fr 0.9fr 0.9fr 1.1fr 0.7fr;
      gap: 6px;
      font-size: 11px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .player-head div {
      text-align: center;
    }

    .player-head div:first-child {
      text-align: left;
    }

    .player-row {
      display: grid;
      grid-template-columns: 1.3fr 0.9fr 0.9fr 1.1fr 0.7fr;
      gap: 6px;
      align-items: center;
      margin-bottom: 6px;
      padding: 4px 4px;
      border-radius: 8px;
      border: 1px solid transparent;
      transition: background 0.15s, border-color 0.15s;
    }

    .player-row.biggest {
      border-color: #ff9500;
      background: rgba(255,149,0,0.08);
    }

    .player-row.smallest {
      border-color: #34c759;
      background: rgba(52,199,89,0.08);
    }

    .counter {
      display: flex;
      align-items: center;
      gap: 4px;
      justify-content: center;
    }

    .counter button {
      width: 28px;
      height: 28px;
      border-radius: 6px;
      border: none;
      font-size: 18px;
      font-weight: 600;
      background: #f2f2f7;
      cursor: pointer;
      padding: 0;
    }

    .counter input {
      width: 48px;
      text-align: center;
      padding: 4px;
      border-radius: 6px;
      border: 1px solid #d0d0d4;
      font-size: 14px;
      background: #ffffff;
      color: inherit;
    }

    .spent-label {
      font-size: 14px;
      text-align: right;
      padding-right: 4px;
      min-width: 80px;
    }

    .position-input {
      width: 100%;
      text-align: center;
    }

    .summary-item {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      margin-bottom: 4px;
    }

    .summary-item strong {
      font-weight: 600;
    }

    .total-pot {
      font-size: 18px;
      font-weight: 700;
      margin-top: 6px;
    }

    .btn {
      border: none;
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
    }

    .btn-primary {
      background: #007aff;
      color: white;
      width: 100%;
      margin-top: 8px;
    }

    .btn-secondary {
      background: #f2f2f7;
      color: #111;
      width: 100%;
      margin-top: 6px;
    }

    .btn-danger {
      background: #ff3b30;
      color: white;
      width: 100%;
      margin-top: 8px;
    }

    .small-note {
      font-size: 11px;
      color: #888;
      margin-top: 4px;
    }

    .warning {
      color: #c00;
      font-size: 12px;
      margin-top: 4px;
    }

    footer {
      font-size: 11px;
      text-align: center;
      padding: 6px 12px 10px;
      color: #666;
    }

    /* Dark mode */
    body.dark {
      background: #111111;
      color: #f5f5f5;
    }

    body.dark header {
      background: #1c1c1e;
      box-shadow: 0 1px 3px rgba(0,0,0,0.7);
    }

    body.dark .card {
      background: #1c1c1e;
      box-shadow: 0 1px 3px rgba(0,0,0,0.7);
      border: 1px solid #2c2c2e;
    }

    body.dark input[type="number"],
    body.dark input[type="text"] {
      background: #2c2c2e;
      border-color: #3a3a3c;
      color: #f5f5f5;
    }

    body.dark .counter button {
      background: #2c2c2e;
      color: #f5f5f5;
    }

    body.dark .btn-primary {
      background: #0a84ff;
    }

    body.dark .btn-secondary {
      background: #2c2c2e;
      color: #f5f5f5;
    }

    body.dark .btn-danger {
      background: #ff453a;
    }

    body.dark .small-note {
      color: #aaa;
    }

    body.dark footer {
      color: #999;
    }

    body.dark .player-row.biggest {
      background: rgba(255,159,10,0.25);
      border-color: #ff9f0a;
    }

    body.dark .player-row.smallest {
      background: rgba(48,209,88,0.3);
      border-color: #30d158;
    }

    body.dark .results-date {
      color: #aaa;
    }

    @media (max-width: 480px) {
      .player-head,
      .player-row {
        grid-template-columns: 1.3fr 0.9fr 0.9fr 1.1fr 0.7fr;
      }
    }

    /* Listas de ranking / resumo */
    .ranking-list {
      margin-top: 8px;
      font-size: 14px;
    }
    .ranking-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 2px 0;
    }
    .ranking-left {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .ranking-icon {
      width: 22px;
      text-align: center;
    }
    .ranking-name {
      max-width: 160px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Canvas (card PNG) */
    #summaryCanvas {
      display: none;
    }
  </style>
</head>
<body>
  <header>
    <h1 id="headerTitle">Poker</h1>
    <button id="themeToggle" class="theme-toggle" aria-label="Alternar tema">ðŸŒ™</button>
  </header>

  <main>
    <!-- ConfiguraÃ§Ãµes -->
    <section class="card">
      <div class="card-title">ConfiguraÃ§Ãµes da rodada</div>
      <div class="row">
        <div>
          <label for="buyInValue">Valor do buy-in (R$)</label>
          <input id="buyInValue" type="number" min="0" step="0.01" inputmode="decimal" />
        </div>
        <div>
          <label for="rebuyValue">Valor do rebuy (R$)</label>
          <input id="rebuyValue" type="number" min="0" step="0.01" inputmode="decimal" />
        </div>
      </div>

      <div style="margin-top:8px;">
        <div class="card-title" style="font-size:14px;margin-bottom:4px;">DistribuiÃ§Ã£o de prÃªmios (%)</div>
        <div class="row">
          <div>
            <label for="prize1">1Âº lugar</label>
            <input id="prize1" type="number" min="0" max="100" step="1" />
          </div>
          <div>
            <label for="prize2">2Âº lugar</label>
            <input id="prize2" type="number" min="0" max="100" step="1" />
          </div>
          <div>
            <label for="prize3">3Âº lugar</label>
            <input id="prize3" type="number" min="0" max="100" step="1" />
          </div>
        </div>
        <div id="prizeSumWarning" class="warning" style="display:none;"></div>
        <div class="small-note">Dica: normalmente a soma dÃ¡ 100%.</div>
      </div>

      <button id="resetSession" class="btn btn-danger">Zerar rodada</button>
    </section>

    <!-- Jogadores -->
    <section class="card">
      <div class="card-title">Jogadores</div>
      <div class="player-head">
        <div>Jogador</div>
        <div>Buy-ins</div>
        <div>Rebuys</div>
        <div>Total gasto</div>
        <div>PosiÃ§Ã£o</div>
      </div>
      <div id="playersContainer"></div>
      <div class="small-note">
        A lista acima jÃ¡ estÃ¡ ordenada pelo total gasto (do maior para o menor).
      </div>
    </section>

    <!-- RESULTADOS -->
    <section class="card">
      <div class="card-title">
        <span>RESULTADOS</span>
        <span id="resultsDateLabel" class="results-date"></span>
      </div>

      <div class="summary-item">
        <span>Total de buy-ins</span><strong id="totalBuyIns">0</strong>
      </div>
      <div class="summary-item">
        <span>Total de rebuys</span><strong id="totalRebuys">0</strong>
      </div>
      <div class="total-pot">
        Pote total: <span id="totalPot">R$ 0,00</span>
      </div>

      <hr style="margin:12px 0;border:none;border-top:1px solid #eee;">

      <div class="summary-item">
        <span>1Âº lugar</span><strong id="prize1Amount">R$ 0,00</strong>
      </div>
      <div class="summary-item">
        <span>2Âº lugar</span><strong id="prize2Amount">R$ 0,00</strong>
      </div>
      <div class="summary-item">
        <span>3Âº lugar</span><strong id="prize3Amount">R$ 0,00</strong>
      </div>

      <button id="recalcBtn" class="btn btn-primary">Recalcular</button>
      <button id="whatsappShareBtn" class="btn btn-secondary">Enviar resumo no WhatsApp</button>
      <button id="pngCardBtn" class="btn btn-secondary">Gerar card em PNG</button>

      <div class="small-note" style="margin-top:10px;font-weight:600;">
        ColocaÃ§Ãµes:
      </div>
      <div id="rankingList" class="ranking-list"></div>

      <div class="small-note" style="margin-top:10px;font-weight:600;">
        Jogadores com 1 ou mais buy-ins:
      </div>
      <div id="playersSummaryList" class="ranking-list"></div>

      <!-- Canvas escondido para gerar o card PNG -->
      <canvas id="summaryCanvas" width="900" height="700"></canvas>
    </section>
  </main>

  <footer>
    Dados ficam somente neste dispositivo Â· Funciona offline apÃ³s o primeiro acesso
  </footer>

  <script>
    const STORAGE_KEY = "poker_tracker_state_v3";
    const THEME_KEY = "poker_tracker_theme";

    // FormataÃ§Ã£o R$
    let moneyFormatter;
    try {
      moneyFormatter = new Intl.NumberFormat("pt-BR", {
        style: "currency",
        currency: "BRL",
        minimumFractionDigits: 2
      });
    } catch (e) {
      moneyFormatter = {
        format(v) {
          return "R$ " + Number(v).toFixed(2).replace(".", ",");
        }
      };
    }

    function formatMoney(v) {
      return moneyFormatter.format(v || 0);
    }

    function toNumber(v, def = 0) {
      if (v === null || v === undefined) return def;
      const normalized = String(v).replace(",", ".");
      const n = parseFloat(normalized);
      return isNaN(n) ? def : n;
    }

    function defaultState() {
      return {
        settings: {
          buyInValue: 100,
          rebuyValue: 100,
          prize1: 50,
          prize2: 30,
          prize3: 20
        },
        players: Array.from({ length: 10 }, (_, i) => ({
          id: i,
          name: "",
          buyIns: 0,
          rebuys: 0,
          placement: 0
        }))
      };
    }

    function loadState() {
      try {
        const data = localStorage.getItem(STORAGE_KEY);
        if (!data) return defaultState();
        const parsed = JSON.parse(data);

        if (!parsed.players || parsed.players.length !== 10) {
          parsed.players = defaultState().players;
        } else {
          parsed.players = parsed.players.map((p, i) => ({
            id: i,
            name: p.name || "",
            buyIns: toNumber(p.buyIns, 0),
            rebuys: toNumber(p.rebuys, 0),
            placement: toNumber(p.placement, 0)
          }));
        }
        return parsed;
      } catch (e) {
        console.error("Error loading state", e);
        return defaultState();
      }
    }

    function saveState(state) {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      } catch (e) {
        console.error("Error saving state", e);
      }
    }

    let state = loadState();

    // Data de hoje
    function getTodayString() {
      try {
        return new Date().toLocaleDateString("pt-BR");
      } catch (e) {
        return "";
      }
    }

    // DOM refs
    const headerTitleEl = document.getElementById("headerTitle");
    const resultsDateLabelEl = document.getElementById("resultsDateLabel");

    const buyInInput = document.getElementById("buyInValue");
    const rebuyInput = document.getElementById("rebuyValue");
    const prize1Input = document.getElementById("prize1");
    const prize2Input = document.getElementById("prize2");
    const prize3Input = document.getElementById("prize3");
    const prizeSumWarning = document.getElementById("prizeSumWarning");
    const playersContainer = document.getElementById("playersContainer");

    const totalBuyInsEl = document.getElementById("totalBuyIns");
    const totalRebuysEl = document.getElementById("totalRebuys");
    const totalPotEl = document.getElementById("totalPot");
    const prize1AmountEl = document.getElementById("prize1Amount");
    const prize2AmountEl = document.getElementById("prize2Amount");
    const prize3AmountEl = document.getElementById("prize3Amount");

    const rankingListEl = document.getElementById("rankingList");
    const playersSummaryListEl = document.getElementById("playersSummaryList");

    const themeToggleBtn = document.getElementById("themeToggle");
    const whatsappShareBtn = document.getElementById("whatsappShareBtn");
    const pngCardBtn = document.getElementById("pngCardBtn");
    const summaryCanvas = document.getElementById("summaryCanvas");

    function updateDateLabels() {
      const d = getTodayString();
      if (headerTitleEl) {
        headerTitleEl.textContent = d ? "Poker - " + d : "Poker";
      }
      if (resultsDateLabelEl) {
        resultsDateLabelEl.textContent = d ? d : "";
      }
    }

    // Tema
    function applyTheme(theme) {
      if (theme === "dark") {
        document.body.classList.add("dark");
        themeToggleBtn.textContent = "â˜€ï¸";
      } else {
        document.body.classList.remove("dark");
        themeToggleBtn.textContent = "ðŸŒ™";
      }
    }

    function loadTheme() {
      const stored = localStorage.getItem(THEME_KEY);
      const theme = stored === "dark" ? "dark" : "light";
      applyTheme(theme);
    }

    function toggleTheme() {
      const isDark = document.body.classList.contains("dark");
      const newTheme = isDark ? "light" : "dark";
      applyTheme(newTheme);
      localStorage.setItem(THEME_KEY, newTheme);
    }

    themeToggleBtn.addEventListener("click", toggleTheme);
    loadTheme();
    updateDateLabels();

    function renderSettings() {
      buyInInput.value = state.settings.buyInValue;
      rebuyInput.value = state.settings.rebuyValue;
      prize1Input.value = state.settings.prize1;
      prize2Input.value = state.settings.prize2;
      prize3Input.value = state.settings.prize3;
      updatePrizeSumWarning();
    }

    function updatePrizeSumWarning() {
      const s = state.settings;
      const sum =
        toNumber(s.prize1) + toNumber(s.prize2) + toNumber(s.prize3);
      if (sum !== 100) {
        prizeSumWarning.style.display = "block";
        prizeSumWarning.textContent =
          "AtenÃ§Ã£o: a soma dos prÃªmios Ã© " + sum + "% (nÃ£o 100%).";
      } else {
        prizeSumWarning.style.display = "none";
      }
    }

    function buildPlayersWithTotals() {
      const buyInValue = toNumber(state.settings.buyInValue);
      const rebuyValue = toNumber(state.settings.rebuyValue);

      return state.players.map((p, index) => {
        const totalSpent = p.buyIns * buyInValue + p.rebuys * rebuyValue;
        return { ...p, index, totalSpent };
      });
    }

    function renderRankingAndSummary(playersWithTotalsSorted) {
      const buyInValue = toNumber(state.settings.buyInValue);
      const rebuyValue = toNumber(state.settings.rebuyValue);

      rankingListEl.innerHTML = "";
      playersSummaryListEl.innerHTML = "";

      // Ranking por colocaÃ§Ã£o (somente jogadores com posiÃ§Ã£o > 0 e ao menos 1 buy-in)
      const rankingPlayers = playersWithTotalsSorted
        .filter(p => toNumber(p.placement, 0) > 0 && p.buyIns > 0)
        .sort((a, b) => toNumber(a.placement, 0) - toNumber(b.placement, 0));

      if (rankingPlayers.length === 0) {
        rankingListEl.innerHTML =
          '<div class="small-note">Ainda nÃ£o hÃ¡ colocaÃ§Ãµes definidas.</div>';
      } else {
        rankingPlayers.forEach((p) => {
          const div = document.createElement("div");
          div.className = "ranking-item";

          const left = document.createElement("div");
          left.className = "ranking-left";

          const icon = document.createElement("div");
          icon.className = "ranking-icon";

          const place = toNumber(p.placement, 0);
          if (place === 1) icon.textContent = "ðŸ¥‡";
          else if (place === 2) icon.textContent = "ðŸ¥ˆ";
          else if (place === 3) icon.textContent = "ðŸ¥‰";
          else icon.textContent = place + "Âº";

          const nameSpan = document.createElement("span");
          nameSpan.className = "ranking-name";
          nameSpan.textContent = p.name || ("Jogador " + (p.index + 1));

          left.appendChild(icon);
          left.appendChild(nameSpan);

          const right = document.createElement("div");
          right.textContent = formatMoney(p.totalSpent);

          div.appendChild(left);
          div.appendChild(right);
          rankingListEl.appendChild(div);
        });
      }

      // Lista de todos os jogadores com 1+ buy-in
      const summaryPlayers = playersWithTotalsSorted
        .filter(p => p.buyIns >= 1)
        .sort((a, b) => b.totalSpent - a.totalSpent);

      if (summaryPlayers.length === 0) {
        playersSummaryListEl.innerHTML =
          '<div class="small-note">Nenhum jogador com buy-in registrado.</div>';
      } else {
        summaryPlayers.forEach((p) => {
          const div = document.createElement("div");
          div.className = "ranking-item";

          const left = document.createElement("div");
          left.className = "ranking-left";

          const nameSpan = document.createElement("span");
          nameSpan.className = "ranking-name";
          const name = p.name || ("Jogador " + (p.index + 1));
          nameSpan.textContent = name;

          left.appendChild(nameSpan);

          const right = document.createElement("div");
          const totalBuyInValue = p.buyIns * buyInValue;
          const totalRebuyValue = p.rebuys * rebuyValue;
          right.textContent =
            `BI: ${p.buyIns} (${formatMoney(totalBuyInValue)}) | ` +
            `RB: ${p.rebuys} (${formatMoney(totalRebuyValue)}) | ` +
            `TOTAL: ${formatMoney(p.totalSpent)}`;

          div.appendChild(left);
          div.appendChild(right);
          playersSummaryListEl.appendChild(div);
        });
      }
    }

    function renderPlayers() {
      playersContainer.innerHTML = "";

      const playersWithTotals = buildPlayersWithTotals();
      const totals = playersWithTotals.map((p) => p.totalSpent);
      const maxSpent = Math.max(...totals, 0);
      const positiveTotals = totals.filter((v) => v > 0);
      const minSpent =
        positiveTotals.length > 0 ? Math.min(...positiveTotals) : 0;

      // Ordena do maior gasto para o menor
      playersWithTotals.sort((a, b) => b.totalSpent - a.totalSpent);

      playersWithTotals.forEach((p) => {
        const row = document.createElement("div");
        row.className = "player-row";

        if (p.totalSpent > 0 && p.totalSpent === maxSpent) {
          row.classList.add("biggest");
        }
        if (p.totalSpent > 0 && p.totalSpent === minSpent && maxSpent !== minSpent) {
          row.classList.add("smallest");
        }

        // Nome
        const nameDiv = document.createElement("div");
        const nameInput = document.createElement("input");
        nameInput.type = "text";
        nameInput.placeholder = "Jogador " + (p.index + 1);
        nameInput.value = p.name || "";
        nameInput.addEventListener("input", () => {
          state.players[p.index].name = nameInput.value;
          saveState(state);
          renderRankingAndSummary(buildPlayersWithTotals().sort((a, b) => b.totalSpent - a.totalSpent));
        });
        nameDiv.appendChild(nameInput);

        // Buy-ins
        const buyDiv = document.createElement("div");
        const buyCounter = document.createElement("div");
        buyCounter.className = "counter";

        const buyMinus = document.createElement("button");
        buyMinus.textContent = "â€“";

        const buyInput = document.createElement("input");
        buyInput.type = "number";
        buyInput.min = "0";
        buyInput.step = "1";
        buyInput.value = p.buyIns;

        const buyPlus = document.createElement("button");
        buyPlus.textContent = "+";

        buyCounter.appendChild(buyMinus);
        buyCounter.appendChild(buyInput);
        buyCounter.appendChild(buyPlus);
        buyDiv.appendChild(buyCounter);

        // Rebuys
        const rebuyDiv = document.createElement("div");
        const rebuyCounter = document.createElement("div");
        rebuyCounter.className = "counter";

        const rebuyMinus = document.createElement("button");
        rebuyMinus.textContent = "â€“";

        const rebuyInput = document.createElement("input");
        rebuyInput.type = "number";
        rebuyInput.min = "0";
        rebuyInput.step = "1";
        rebuyInput.value = p.rebuys;

        const rebuyPlus = document.createElement("button");
        rebuyPlus.textContent = "+";

        rebuyCounter.appendChild(rebuyMinus);
        rebuyCounter.appendChild(rebuyInput);
        rebuyCounter.appendChild(rebuyPlus);
        rebuyDiv.appendChild(rebuyCounter);

        // Total gasto
        const spentDiv = document.createElement("div");
        const spentLabel = document.createElement("div");
        spentLabel.className = "spent-label";
        spentLabel.textContent = formatMoney(p.totalSpent);
        spentDiv.appendChild(spentLabel);

        // PosiÃ§Ã£o
        const posDiv = document.createElement("div");
        const posInput = document.createElement("input");
        posInput.type = "number";
        posInput.min = "0";
        posInput.step = "1";
        posInput.value = p.placement || 0;
        posInput.className = "position-input";
        posInput.addEventListener("change", () => {
          const idx = p.index;
          state.players[idx].placement = Math.max(
            0,
            Math.floor(toNumber(posInput.value, 0))
          );
          saveState(state);
          renderRankingAndSummary(buildPlayersWithTotals().sort((a, b) => b.totalSpent - a.totalSpent));
        });
        posDiv.appendChild(posInput);

        row.appendChild(nameDiv);
        row.appendChild(buyDiv);
        row.appendChild(rebuyDiv);
        row.appendChild(spentDiv);
        row.appendChild(posDiv);
        playersContainer.appendChild(row);

        function updatePlayer(newBuyIns, newRebuys) {
          const idx = p.index;
          state.players[idx].buyIns = Math.max(
            0,
            Math.floor(toNumber(newBuyIns, 0))
          );
          state.players[idx].rebuys = Math.max(
            0,
            Math.floor(toNumber(newRebuys, 0))
          );
          saveState(state);
          renderPlayers();
          recalc();
        }

        buyMinus.addEventListener("click", () => {
          updatePlayer(p.buyIns - 1, p.rebuys);
        });
        buyPlus.addEventListener("click", () => {
          updatePlayer(p.buyIns + 1, p.rebuys);
        });
        rebuyMinus.addEventListener("click", () => {
          updatePlayer(p.buyIns, p.rebuys - 1);
        });
        rebuyPlus.addEventListener("click", () => {
          updatePlayer(p.buyIns, p.rebuys + 1);
        });

        buyInput.addEventListener("change", () => {
          updatePlayer(buyInput.value, p.rebuys);
        });
        rebuyInput.addEventListener("change", () => {
          updatePlayer(p.buyIns, rebuyInput.value);
        });
      });

      // Atualiza ranking e resumo com mesma ordem base
      renderRankingAndSummary(playersWithTotals);
    }

    function recalc() {
      const buyInValue = toNumber(state.settings.buyInValue);
      const rebuyValue = toNumber(state.settings.rebuyValue);

      let totalBuyIns = 0;
      let totalRebuys = 0;
      state.players.forEach((p) => {
        totalBuyIns += toNumber(p.buyIns);
        totalRebuys += toNumber(p.rebuys);
      });

      const totalFromBuyIns = totalBuyIns * buyInValue;
      const totalFromRebuys = totalRebuys * rebuyValue;
      const totalPot = totalFromBuyIns + totalFromRebuys;

      totalBuyInsEl.textContent = totalBuyIns;
      totalRebuysEl.textContent = totalRebuys;
      totalPotEl.textContent = formatMoney(totalPot);

      const p1 = toNumber(state.settings.prize1);
      const p2 = toNumber(state.settings.prize2);
      const p3 = toNumber(state.settings.prize3);

      let prize1Amount = (totalPot * p1) / 100;
      let prize2Amount = (totalPot * p2) / 100;
      let prize3Amount = (totalPot * p3) / 100;

      const totalPrizes = prize1Amount + prize2Amount + prize3Amount;
      const diff = totalPot - totalPrizes;
      prize1Amount += diff; // ajusta centavos

      prize1AmountEl.textContent = formatMoney(prize1Amount);
      prize2AmountEl.textContent = formatMoney(prize2Amount);
      prize3AmountEl.textContent = formatMoney(prize3Amount);
    }

    // Resumo para WhatsApp
    function buildWhatsappSummary() {
      const buyInValue = toNumber(state.settings.buyInValue);
      const rebuyValue = toNumber(state.settings.rebuyValue);

      let totalBuyIns = 0;
      let totalRebuys = 0;
      state.players.forEach((p) => {
        totalBuyIns += toNumber(p.buyIns);
        totalRebuys += toNumber(p.rebuys);
      });

      const totalPot = totalBuyIns * buyInValue + totalRebuys * rebuyValue;
      const playersSorted = buildPlayersWithTotals().sort((a, b) => b.totalSpent - a.totalSpent);

      const rankingPlayers = playersSorted
        .filter(p => toNumber(p.placement, 0) > 0 && p.buyIns > 0)
        .sort((a, b) => toNumber(a.placement, 0) - toNumber(b.placement, 0));

      const summaryPlayers = playersSorted
        .filter(p => p.buyIns >= 1)
        .sort((a, b) => b.totalSpent - a.totalSpent);

      const today = getTodayString();

      let lines = [];
      if (today) {
        lines.push("Resumo da rodada de poker - " + today);
      } else {
        lines.push("Resumo da rodada de poker");
      }
      lines.push(`Pote total: ${formatMoney(totalPot)}`);
      lines.push(`Buy-ins: ${totalBuyIns} Â· Rebuys: ${totalRebuys}`);
      lines.push("");

      if (rankingPlayers.length > 0) {
        lines.push("ColocaÃ§Ãµes:");
        rankingPlayers.forEach((p) => {
          const place = toNumber(p.placement, 0);
          let icon = "";
          if (place === 1) icon = "ðŸ¥‡";
          else if (place === 2) icon = "ðŸ¥ˆ";
          else if (place === 3) icon = "ðŸ¥‰";
          else icon = place + "Âº";

          const name = p.name || `Jogador ${p.index + 1}`;
          lines.push(`${icon} ${name} â€“ ${formatMoney(p.totalSpent)}`);
        });
        lines.push("");
      } else {
        lines.push("Sem colocaÃ§Ãµes definidas.");
        lines.push("");
      }

      lines.push("Jogadores com 1 ou mais buy-ins:");
      if (summaryPlayers.length === 0) {
        lines.push("Nenhum jogador com buy-in registrado.");
      } else {
        summaryPlayers.forEach((p) => {
          const name = p.name || `Jogador ${p.index + 1}`;
          const totalBuyInValue = p.buyIns * buyInValue;
          const totalRebuyValue = p.rebuys * rebuyValue;
          lines.push(
            `${name} - BI: ${p.buyIns} (${formatMoney(totalBuyInValue)}) | ` +
            `RB: ${p.rebuys} (${formatMoney(totalRebuyValue)}) | ` +
            `TOTAL: ${formatMoney(p.totalSpent)}`
          );
        });
      }

      return lines.join("\n");
    }

    whatsappShareBtn.addEventListener("click", () => {
      const text = buildWhatsappSummary();

      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).catch(() => {});
      }

      const url = "https://wa.me/?text=" + encodeURIComponent(text);
      window.open(url, "_blank");
    });

    // Card em PNG
    function drawSummaryCard() {
      const ctx = summaryCanvas.getContext("2d");
      const width = summaryCanvas.width;
      const height = summaryCanvas.height;

      ctx.fillStyle = "#ffffff";
      ctx.fillRect(0, 0, width, height);

      ctx.fillStyle = "#111111";
      ctx.font = "28px -apple-system, system-ui, sans-serif";
      ctx.fillText("Resumo da rodada de poker", 40, 60);

      const today = getTodayString();
      let y = 100;
      ctx.font = "18px -apple-system, system-ui, sans-serif";
      if (today) {
        ctx.fillText(today, 40, y);
        y += 30;
      }

      const buyInValue = toNumber(state.settings.buyInValue);
      const rebuyValue = toNumber(state.settings.rebuyValue);

      let totalBuyIns = 0;
      let totalRebuys = 0;
      state.players.forEach((p) => {
        totalBuyIns += toNumber(p.buyIns);
        totalRebuys += toNumber(p.rebuys);
      });

      const totalPot = totalBuyIns * buyInValue + totalRebuys * rebuyValue;

      ctx.fillText(`Pote total: ${formatMoney(totalPot)}`, 40, y);
      y += 30;
      ctx.fillText(`Buy-ins: ${totalBuyIns} Â· Rebuys: ${totalRebuys}`, 40, y);
      y += 40;

      const playersSorted = buildPlayersWithTotals().sort((a, b) => b.totalSpent - a.totalSpent);
      const rankingPlayers = playersSorted
        .filter(p => toNumber(p.placement, 0) > 0 && p.buyIns > 0)
        .sort((a, b) => toNumber(a.placement, 0) - toNumber(b.placement, 0));

      const summaryPlayers = playersSorted
        .filter(p => p.buyIns >= 1)
        .sort((a, b) => b.totalSpent - a.totalSpent);

      ctx.fillText("ColocaÃ§Ãµes:", 40, y);
      y += 30;
      ctx.font = "16px -apple-system, system-ui, sans-serif";

      if (rankingPlayers.length === 0) {
        ctx.fillText("Sem colocaÃ§Ãµes definidas.", 40, y);
        y += 30;
      } else {
        rankingPlayers.forEach((p) => {
          const place = toNumber(p.placement, 0);
          let icon = "";
          if (place === 1) icon = "ðŸ¥‡";
          else if (place === 2) icon = "ðŸ¥ˆ";
          else if (place === 3) icon = "ðŸ¥‰";
          else icon = place + "Âº";

          const name = p.name || `Jogador ${p.index + 1}`;
          const line = `${icon} ${name} â€“ ${formatMoney(p.totalSpent)}`;
          ctx.fillText(line, 40, y);
          y += 24;
        });
      }

      y += 20;
      ctx.font = "18px -apple-system, system-ui, sans-serif";
      ctx.fillText("Jogadores com 1 ou mais buy-ins:", 40, y);
      y += 30;
      ctx.font = "16px -apple-system, system-ui, sans-serif";

      if (summaryPlayers.length === 0) {
        ctx.fillText("Nenhum jogador com buy-in registrado.", 40, y);
      } else {
        summaryPlayers.forEach((p) => {
          const name = p.name || `Jogador ${p.index + 1}`;
          const totalBuyInValue = p.buyIns * buyInValue;
          const totalRebuyValue = p.rebuys * rebuyValue;
          const line =
            `${name} - BI: ${p.buyIns} (${formatMoney(totalBuyInValue)}) | ` +
            `RB: ${p.rebuys} (${formatMoney(totalRebuyValue)}) | ` +
            `TOTAL: ${formatMoney(p.totalSpent)}`;
          if (y < height - 20) {
            ctx.fillText(line, 40, y);
            y += 22;
          }
        });
      }
    }

    pngCardBtn.addEventListener("click", () => {
      drawSummaryCard();
      const dataUrl = summaryCanvas.toDataURL("image/png");

      const link = document.createElement("a");
      link.href = dataUrl;
      link.download = "poker_resumo.png";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });

    // Listeners de settings
    buyInInput.addEventListener("change", () => {
      state.settings.buyInValue = toNumber(buyInInput.value, 0);
      saveState(state);
      renderPlayers();
      recalc();
    });

    rebuyInput.addEventListener("change", () => {
      state.settings.rebuyValue = toNumber(rebuyInput.value, 0);
      saveState(state);
      renderPlayers();
      recalc();
    });

    function updatePrizeSetting() {
      state.settings.prize1 = toNumber(prize1Input.value, 0);
      state.settings.prize2 = toNumber(prize2Input.value, 0);
      state.settings.prize3 = toNumber(prize3Input.value, 0);
      saveState(state);
      updatePrizeSumWarning();
      recalc();
    }

    prize1Input.addEventListener("change", updatePrizeSetting);
    prize2Input.addEventListener("change", updatePrizeSetting);
    prize3Input.addEventListener("change", updatePrizeSetting);

    document.getElementById("recalcBtn").addEventListener("click", () => {
      renderPlayers();
      recalc();
    });

    document.getElementById("resetSession").addEventListener("click", () => {
      if (!confirm("Zerar todos os jogadores e configuraÃ§Ãµes?")) return;
      state = defaultState();
      saveState(state);
      renderSettings();
      renderPlayers();
      recalc();
    });

    // InicializaÃ§Ã£o
    renderSettings();
    renderPlayers();
    recalc();

    // PWA service worker
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker
          .register("sw.js")
          .catch((err) => console.error("SW registration failed", err));
      });
    }
  </script>
</body>
</html>
